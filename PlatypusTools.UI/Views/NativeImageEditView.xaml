<UserControl x:Class="PlatypusTools.UI.Views.NativeImageEditView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d"
             d:DesignHeight="800" d:DesignWidth="1200">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <!-- Compact tool button style -->
        <Style x:Key="ToolBtn" TargetType="Button">
            <Setter Property="Height" Value="26"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Padding" Value="6,2"/>
            <Setter Property="Margin" Value="1"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
        </Style>
        <Style x:Key="ToolBtnSmall" TargetType="Button">
            <Setter Property="Height" Value="24"/>
            <Setter Property="Width" Value="24"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="1"/>
        </Style>
        <Style x:Key="SectionLabel" TargetType="TextBlock">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="Foreground" Value="#555"/>
            <Setter Property="Margin" Value="0,6,0,2"/>
        </Style>
    </UserControl.Resources>
    
    <Grid Margin="2">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Row 0: Compact top bar (File + View toggles) -->
        <Border Grid.Row="0" BorderBrush="#CCC" BorderThickness="0,0,0,1" Padding="4,2">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="File:" VerticalAlignment="Center" FontSize="11" Margin="0,0,4,0"/>
                <TextBox x:Name="ImageFilePathBox" Grid.Column="1" IsReadOnly="True" FontSize="11" Height="22" VerticalContentAlignment="Center" Margin="0,0,4,0"/>
                <Button Grid.Column="2" Content="ðŸ“‚ Open" Click="BrowseImage_Click" Style="{StaticResource ToolBtn}" Width="70"/>
                <Button Grid.Column="3" Content="ðŸ†• New" Click="NewImage_Click" Style="{StaticResource ToolBtn}" Width="60" ToolTip="Create a new blank canvas"/>
                <Button Grid.Column="4" Content="ðŸ“‹ Paste" Click="PasteImage_Click" Style="{StaticResource ToolBtn}" Width="65" ToolTip="Paste image from clipboard"/>
                <Separator Grid.Column="5" Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="6,2"/>
                <StackPanel Grid.Column="6" Orientation="Horizontal" Margin="2,0">
                    <TextBlock Text="View:" VerticalAlignment="Center" FontSize="10" Margin="0,0,4,0"/>
                    <ToggleButton x:Name="ToggleToolsPanel" Content="ðŸ”§" Width="28" Height="22" FontSize="11" IsChecked="True"
                                  ToolTip="Toggle Tools panel" Click="ToggleToolsPanel_Click"/>
                    <ToggleButton x:Name="ToggleSettingsPanel" Content="âš™" Width="28" Height="22" FontSize="11" IsChecked="True" Margin="2,0,0,0"
                                  ToolTip="Toggle Settings panel" Click="ToggleSettingsPanel_Click"/>
                </StackPanel>
                <StackPanel Grid.Column="7" Orientation="Horizontal" Margin="6,0,0,0">
                    <Button Content="â†© Undo" Click="Undo_Click" Style="{StaticResource ToolBtn}" Width="60"/>
                    <Button Content="â†© Reset" Click="Reset_Click" Style="{StaticResource ToolBtn}" Width="60"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Row 1: Main 3-column layout (Tools | Canvas | Settings+Layers) -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="ToolsColumn" Width="155"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition x:Name="SettingsColumn" Width="185"/>
            </Grid.ColumnDefinitions>
            
            <!-- LEFT PANEL: Tools -->
            <Border x:Name="ToolsPanel" Grid.Column="0" BorderBrush="#DDD" BorderThickness="0,0,1,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                    <StackPanel Margin="3">
                        <!-- Transform -->
                        <TextBlock Text="TRANSFORM" Style="{StaticResource SectionLabel}"/>
                        <Button Content="â†¶ Rotate Left" Click="RotateLeft_Click" Style="{StaticResource ToolBtn}"/>
                        <Button Content="â†· Rotate Right" Click="RotateRight_Click" Style="{StaticResource ToolBtn}"/>
                        <Button Content="â†” Flip H" Click="FlipH_Click" Style="{StaticResource ToolBtn}"/>
                        <Button Content="â†• Flip V" Click="FlipV_Click" Style="{StaticResource ToolBtn}"/>
                        <Button Content="âœ‚ Crop" Click="StartCrop_Click" Style="{StaticResource ToolBtn}" ToolTip="Click and drag to select crop region"/>
                        <Button Content="ðŸ“ Resize" Click="Resize_Click" Style="{StaticResource ToolBtn}"/>
                        
                        <!-- Effects -->
                        <TextBlock Text="EFFECTS" Style="{StaticResource SectionLabel}"/>
                        <Button Content="ðŸŽ¨ Grayscale" Click="Grayscale_Click" Style="{StaticResource ToolBtn}"/>
                        <Button Content="ðŸ”„ Invert" Click="Invert_Click" Style="{StaticResource ToolBtn}"/>
                        <Button Content="â˜€ Brightness" Click="Brightness_Click" Style="{StaticResource ToolBtn}"/>
                        <Button Content="ðŸŒ“ Contrast" Click="Contrast_Click" Style="{StaticResource ToolBtn}"/>
                        <Button Content="ðŸŒŠ Blur" Click="Blur_Click" Style="{StaticResource ToolBtn}"/>
                        <Button Content="ðŸ”ª Sharpen" Click="Sharpen_Click" Style="{StaticResource ToolBtn}"/>
                        
                        <!-- Annotate -->
                        <TextBlock Text="ANNOTATE" Style="{StaticResource SectionLabel}"/>
                        <Button x:Name="BtnArrow" Content="âžœ Arrow" Click="SetAnnotationMode_Click" MouseRightButtonDown="ShapeButton_RightClick" Tag="Arrow" Style="{StaticResource ToolBtn}" ToolTip="Arrow (Right-click: fill mode)"/>
                        <Button x:Name="BtnRect" Content="â–¢ Rect" Click="SetAnnotationMode_Click" MouseRightButtonDown="ShapeButton_RightClick" Tag="Rectangle" Style="{StaticResource ToolBtn}" ToolTip="Rectangle (Right-click: fill mode)"/>
                        <Button x:Name="BtnEllipse" Content="â—‹ Ellipse" Click="SetAnnotationMode_Click" MouseRightButtonDown="ShapeButton_RightClick" Tag="Ellipse" Style="{StaticResource ToolBtn}" ToolTip="Ellipse (Right-click: fill mode)"/>
                        <Button x:Name="BtnText" Content="T Text" Click="SetAnnotationMode_Click" Tag="Text" Style="{StaticResource ToolBtn}"/>
                        <Button x:Name="BtnHighlight" Content="â–® Highlight" Click="SetAnnotationMode_Click" Tag="Highlight" Style="{StaticResource ToolBtn}"/>
                        <Button x:Name="BtnFreehand" Content="âœŽ Draw" Click="SetAnnotationMode_Click" Tag="Freehand" Style="{StaticResource ToolBtn}"/>
                        <Button x:Name="BtnFill" Content="ðŸª£ Fill" Click="SetAnnotationMode_Click" Tag="Fill" Style="{StaticResource ToolBtn}" ToolTip="Flood Fill"/>
                        <CheckBox x:Name="FillShapesCheckBox" Content="Fill Shapes" FontSize="10" VerticalAlignment="Center" Margin="2,4,0,0" ToolTip="When checked, shapes will be filled solid"/>
                        <TextBox x:Name="AnnotationTextBox" Height="22" FontSize="10" Margin="1,3,1,0" VerticalContentAlignment="Center" ToolTip="Text for text annotation"/>
                        
                        <!-- Advanced -->
                        <TextBlock Text="ADVANCED" Style="{StaticResource SectionLabel}"/>
                        <Button Content="ðŸŽ¯ Pick Color" Click="ColorPicker_Click" Style="{StaticResource ToolBtn}" ToolTip="Pick a color from the image"/>
                        <Button Content="ðŸ”„ Replace Color" Click="ReplaceColor_Click" Style="{StaticResource ToolBtn}" ToolTip="Replace one color with another"/>
                        <Button Content="âœ‚ Rm Background" Click="RemoveBackground_Click" Style="{StaticResource ToolBtn}" ToolTip="Auto-remove background"/>
                        <Button Content="ðŸª„ Magic Select" Click="MagicSelect_Click" Style="{StaticResource ToolBtn}" ToolTip="Select similar colors"/>
                    </StackPanel>
                </ScrollViewer>
            </Border>
            
            <!-- Left GridSplitter -->
            <GridSplitter x:Name="LeftToolsSplitter" Grid.Column="1" Width="4" HorizontalAlignment="Center" VerticalAlignment="Stretch"
                          Background="#CCC" Cursor="SizeWE" ResizeBehavior="PreviousAndNext"/>
            
            <!-- CENTER: Image Canvas -->
            <Grid Grid.Column="2" Margin="0">
                <ScrollViewer x:Name="ImageScrollViewer" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto"
                              Background="#F0F0F0">
                    <Grid x:Name="CanvasContainer">
                        <Image x:Name="ImagePreview" Stretch="None" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        <Canvas x:Name="DrawingOverlay" 
                                Background="Transparent"
                                HorizontalAlignment="Center" VerticalAlignment="Center"
                                MouseLeftButtonDown="DrawingOverlay_MouseDown"
                                MouseMove="DrawingOverlay_MouseMove"
                                MouseLeftButtonUp="DrawingOverlay_MouseUp"/>
                    </Grid>
                </ScrollViewer>
                <TextBlock x:Name="PlaceholderText" Text="Open an image or create a new canvas to begin" 
                           HorizontalAlignment="Center" VerticalAlignment="Center"
                           Foreground="#999" FontSize="14" FontStyle="Italic" IsHitTestVisible="False"/>
            </Grid>
            
            <!-- Right GridSplitter -->
            <GridSplitter x:Name="RightSettingsSplitter" Grid.Column="3" Width="4" HorizontalAlignment="Center" VerticalAlignment="Stretch"
                          Background="#CCC" Cursor="SizeWE" ResizeBehavior="PreviousAndNext"/>
            
            <!-- RIGHT PANEL: Settings + Layers -->
            <Border x:Name="SettingsPanel" Grid.Column="4" BorderBrush="#DDD" BorderThickness="1,0,0,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                    <StackPanel Margin="4">
                        <!-- Current Tool -->
                        <TextBlock Text="Tool:" FontWeight="SemiBold" FontSize="10" Margin="0,2,0,1"/>
                        <TextBlock x:Name="CurrentToolText" Text="None" Foreground="Blue" FontSize="10" Margin="0,0,0,6"/>
                        
                        <!-- Color Selection -->
                        <TextBlock Text="Draw Color:" FontWeight="SemiBold" FontSize="10" Margin="0,0,0,3"/>
                        <WrapPanel Margin="0,0,0,4">
                            <Border x:Name="ColorRed" Width="20" Height="20" Background="Red" Margin="1" Cursor="Hand" MouseLeftButtonDown="ColorSwatch_Click" CornerRadius="2"/>
                            <Border x:Name="ColorYellow" Width="20" Height="20" Background="Yellow" Margin="1" Cursor="Hand" MouseLeftButtonDown="ColorSwatch_Click" CornerRadius="2"/>
                            <Border x:Name="ColorGreen" Width="20" Height="20" Background="Green" Margin="1" Cursor="Hand" MouseLeftButtonDown="ColorSwatch_Click" CornerRadius="2"/>
                            <Border x:Name="ColorBlue" Width="20" Height="20" Background="Blue" Margin="1" Cursor="Hand" MouseLeftButtonDown="ColorSwatch_Click" CornerRadius="2"/>
                            <Border x:Name="ColorOrange" Width="20" Height="20" Background="Orange" Margin="1" Cursor="Hand" MouseLeftButtonDown="ColorSwatch_Click" CornerRadius="2"/>
                            <Border x:Name="ColorPurple" Width="20" Height="20" Background="Purple" Margin="1" Cursor="Hand" MouseLeftButtonDown="ColorSwatch_Click" CornerRadius="2"/>
                            <Border x:Name="ColorWhite" Width="20" Height="20" Background="White" Margin="1" Cursor="Hand" MouseLeftButtonDown="ColorSwatch_Click" CornerRadius="2" BorderBrush="Gray" BorderThickness="1"/>
                            <Border x:Name="ColorBlack" Width="20" Height="20" Background="Black" Margin="1" Cursor="Hand" MouseLeftButtonDown="ColorSwatch_Click" CornerRadius="2"/>
                        </WrapPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                            <Border x:Name="SelectedColorPreview" Width="30" Height="18" Background="Red" CornerRadius="2" BorderBrush="Gray" BorderThickness="1"/>
                            <Button Content="Custom" Click="CustomColor_Click" Height="20" Width="55" Margin="4,0,0,0" FontSize="10" Padding="2,0"/>
                        </StackPanel>
                        
                        <!-- Picked Color -->
                        <TextBlock Text="Picked:" FontWeight="SemiBold" FontSize="10" Margin="0,4,0,2"/>
                        <StackPanel Orientation="Horizontal">
                            <Border x:Name="PickedColorPreview" Width="30" Height="18" Background="Transparent" CornerRadius="2" BorderBrush="Gray" BorderThickness="1"/>
                            <TextBlock x:Name="PickedColorHex" Text="" VerticalAlignment="Center" Margin="4,0,0,0" FontFamily="Consolas" FontSize="10"/>
                        </StackPanel>
                        
                        <!-- Line Thickness -->
                        <TextBlock Text="Thickness:" FontWeight="SemiBold" FontSize="10" Margin="0,8,0,2"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="ThicknessSlider" Minimum="1" Maximum="20" Value="3" TickFrequency="1" IsSnapToTickEnabled="True" ValueChanged="ThicknessSlider_ValueChanged"/>
                            <TextBlock x:Name="ThicknessText" Grid.Column="1" Text="3 px" FontSize="10" VerticalAlignment="Center" Margin="4,0,0,0" Width="28"/>
                        </Grid>
                        
                        <!-- Color Tolerance -->
                        <TextBlock Text="Tolerance:" FontWeight="SemiBold" FontSize="10" Margin="0,6,0,2"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="ToleranceSlider" Minimum="0" Maximum="100" Value="30" TickFrequency="5" IsSnapToTickEnabled="True" ValueChanged="ToleranceSlider_ValueChanged"/>
                            <TextBlock x:Name="ToleranceText" Grid.Column="1" Text="30%" FontSize="10" VerticalAlignment="Center" Margin="4,0,0,0" Width="28"/>
                        </Grid>
                        
                        <!-- Image Info -->
                        <Separator Margin="0,8,0,4"/>
                        <TextBlock Text="Image Info:" FontWeight="SemiBold" FontSize="10" Margin="0,0,0,2"/>
                        <TextBlock x:Name="ImageInfoText" Text="No image loaded" TextWrapping="Wrap" Foreground="#666" FontSize="10"/>
                        
                        <!-- Layers -->
                        <Separator Margin="0,8,0,4"/>
                        <TextBlock Text="LAYERS" FontWeight="SemiBold" FontSize="10" Foreground="#555" Margin="0,0,0,2"/>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,3">
                            <TextBlock Text="Active:" FontSize="10" Foreground="#888" VerticalAlignment="Center" Margin="0,0,4,0"/>
                            <TextBlock x:Name="ActiveLayerText" Text="Background" FontSize="10" Foreground="Blue" VerticalAlignment="Center"/>
                        </StackPanel>
                        
                        <ListBox x:Name="LayersList" ItemsSource="{Binding Layers, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                 MaxHeight="150" MinHeight="60" SelectionChanged="LayersList_SelectionChanged"
                                 HorizontalContentAlignment="Stretch" FontSize="10">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid Height="18">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <CheckBox IsChecked="{Binding IsVisible}" VerticalAlignment="Center">
                                            <CheckBox.LayoutTransform>
                                                <ScaleTransform ScaleX="0.85" ScaleY="0.85"/>
                                            </CheckBox.LayoutTransform>
                                        </CheckBox>
                                        <TextBlock Grid.Column="1" Text="{Binding Name}" Margin="2,0" VerticalAlignment="Center" FontSize="10" TextTrimming="CharacterEllipsis"/>
                                        <TextBlock Grid.Column="2" Text="{Binding Opacity, StringFormat='{}{0:P0}'}" FontSize="8" Foreground="Gray" VerticalAlignment="Center"/>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                        
                        <!-- Layer action buttons - compact grid layout -->
                        <UniformGrid Columns="7" Margin="0,3,0,0">
                            <Button Content="+" Click="AddLayer_Click" Height="22" ToolTip="Add layer" FontSize="12" FontWeight="Bold" Padding="0"/>
                            <Button Content="âŽ˜" Click="DuplicateLayer_Click" Height="22" ToolTip="Duplicate layer" FontSize="12" Padding="0"/>
                            <Button Content="âœ•" Click="RemoveLayer_Click" Height="22" ToolTip="Remove layer" FontSize="11" Padding="0"/>
                            <Button Content="â–²" Click="MoveLayerUp_Click" Height="22" ToolTip="Move up" FontSize="10" Padding="0"/>
                            <Button Content="â–¼" Click="MoveLayerDown_Click" Height="22" ToolTip="Move down" FontSize="10" Padding="0"/>
                            <Button Content="â¤µ" Click="MergeDown_Click" Height="22" ToolTip="Merge down" FontSize="10" Padding="0"/>
                            <Button Content="â¤“" Click="FlattenLayers_Click" Height="22" ToolTip="Flatten all" FontSize="10" Padding="0"/>
                        </UniformGrid>
                        
                        <Grid Margin="0,4,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="Opacity:" FontSize="10" VerticalAlignment="Center"/>
                            <Slider x:Name="LayerOpacitySlider" Grid.Column="1" Minimum="0" Maximum="100" Value="100" Margin="4,0"
                                    ValueChanged="LayerOpacitySlider_ValueChanged"/>
                            <TextBlock Grid.Column="2" FontSize="9" VerticalAlignment="Center">
                                <TextBlock.Text>
                                    <Binding ElementName="LayerOpacitySlider" Path="Value" StringFormat="{}{0:0}%"/>
                                </TextBlock.Text>
                            </TextBlock>
                        </Grid>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>
        
        <!-- Row 2: Compact bottom bar (Save) -->
        <Border Grid.Row="2" BorderBrush="#CCC" BorderThickness="0,1,0,0" Padding="4,3">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="Format:" VerticalAlignment="Center" FontSize="11" Margin="0,0,4,0"/>
                <ComboBox x:Name="OutputFormat" Grid.Column="1" SelectedIndex="0" Width="80" Height="24" FontSize="11">
                    <ComboBoxItem Content="PNG"/>
                    <ComboBoxItem Content="JPEG"/>
                    <ComboBoxItem Content="BMP"/>
                    <ComboBoxItem Content="GIF"/>
                    <ComboBoxItem Content="WEBP"/>
                    <ComboBoxItem Content="TIFF"/>
                    <ComboBoxItem Content="SVG"/>
                </ComboBox>
                <TextBlock x:Name="StatusText" Grid.Column="2" Text="" Foreground="Blue" VerticalAlignment="Center" FontSize="11" Margin="10,0,0,0"/>
                <Button Grid.Column="3" Content="ðŸ“‹ Copy" Click="CopyToClipboard_Click" Style="{StaticResource ToolBtn}" Width="70" Margin="4,0" ToolTip="Copy image to clipboard"/>
                <Button Grid.Column="4" Content="ðŸ’¾ Save As..." Click="Save_Click" Style="{StaticResource ToolBtn}" Width="90" FontWeight="Bold"
                        Background="#FF4CAF50" Foreground="White"/>
                <Button Grid.Column="5" Content="ðŸ’¾ Quick Save" Click="QuickSave_Click" Style="{StaticResource ToolBtn}" Width="95" Margin="4,0,0,0"
                        Background="#FF2196F3" Foreground="White" ToolTip="Save with same name + _edited"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
