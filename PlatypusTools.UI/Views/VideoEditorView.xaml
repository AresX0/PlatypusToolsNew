<UserControl x:Class="PlatypusTools.UI.Views.VideoEditorView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:PlatypusTools.UI.Views"
             xmlns:vm="clr-namespace:PlatypusTools.UI.ViewModels"
             xmlns:vlc="clr-namespace:LibVLCSharp.WPF;assembly=LibVLCSharp.WPF"
             mc:Ignorable="d"
             d:DesignHeight="800" d:DesignWidth="1400">
    
    <UserControl.DataContext>
        <vm:VideoEditorViewModel />
    </UserControl.DataContext>

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Themes/VideoEditorStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            
            <!-- Timeline clip template -->
            <DataTemplate x:Key="TimelineClipTemplate">
                <Border Background="{Binding Color}" 
                        BorderBrush="#7B8590" BorderThickness="1" 
                        CornerRadius="6" MinWidth="50" Height="50"
                    Cursor="SizeAll"
                    ToolTip="{Binding Name}">
                <Grid>
                    <TextBlock Text="{Binding Name}" 
                               Foreground="White" 
                               FontSize="10"
                               Margin="4,2"
                               TextTrimming="CharacterEllipsis"/>
                    <!-- Trim handles -->
                    <Rectangle Width="6" HorizontalAlignment="Left" 
                               Fill="#80000000" Cursor="SizeWE"/>
                    <Rectangle Width="6" HorizontalAlignment="Right" 
                               Fill="#80000000" Cursor="SizeWE"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- Beat marker template -->
        <DataTemplate x:Key="BeatMarkerTemplate">
            <Line Y1="0" Y2="60" Stroke="#F472B6" StrokeThickness="2"
                  Opacity="0.8"/>
        </DataTemplate>

        <!-- Media library item template with drag support -->
        <DataTemplate x:Key="MediaAssetTemplate">
            <Border Padding="4" Background="#4B5058" CornerRadius="4" Margin="2"
                    MouseMove="MediaAsset_MouseMove" Cursor="Hand">
                <Border.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Add to Timeline" 
                                  Command="{Binding DataContext.DropMediaOnTimelineCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                  CommandParameter="{Binding}"/>
                        <MenuItem Header="Add as Overlay"
                                  Command="{Binding DataContext.AddAsOverlayCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                        <Separator/>
                        <MenuItem Header="Remove Background"
                                  Command="{Binding DataContext.RemoveBackgroundCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                    </ContextMenu>
                </Border.ContextMenu>
                <StackPanel Width="100">
                    <Grid Height="60" Background="#5B616A">
                        <Image Source="{Binding ThumbnailPath}" Stretch="UniformToFill"/>
                        <TextBlock Text="{Binding Type}" 
                                   Foreground="#D1D5DB" FontSize="10"
                                   HorizontalAlignment="Center" 
                                   VerticalAlignment="Center"
                                   Visibility="{Binding ThumbnailPath, Converter={StaticResource NullToVisibilityConverter}}"/>
                        <!-- Duration badge -->
                        <Border Background="#80000000" CornerRadius="2"
                                HorizontalAlignment="Right" VerticalAlignment="Bottom"
                                Padding="3,1" Margin="2">
                            <TextBlock Text="{Binding Duration, StringFormat='{}{0:mm\\:ss}'}" 
                                       Foreground="White" FontSize="9"/>
                        </Border>
                    </Grid>
                    <TextBlock Text="{Binding FileName}" 
                               Foreground="White" FontSize="10"
                               TextTrimming="CharacterEllipsis"
                               Margin="0,4,0,0"
                               ToolTip="{Binding FileName}"/>
                </StackPanel>
            </Border>
        </DataTemplate>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid Background="#3B3F47">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="400" MinHeight="300"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Border Grid.Row="0" Background="#4B5058" Padding="8">
            <DockPanel>
                <!-- Left tools -->
                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal">
                    <Button Content="ðŸ“ New" Command="{Binding NewProjectCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}" Margin="0,0,4,0"/>
                    <Button Content="ðŸ“‚ Open" Command="{Binding OpenProjectCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}" Margin="0,0,4,0"/>
                    <Button Content="ðŸ’¾ Save" Command="{Binding SaveProjectCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}" Margin="0,0,12,0"/>
                    
                    <Separator Style="{StaticResource VerticalSeparatorStyle}"/>
                    
                    <Button Content="â†© Undo" Command="{Binding UndoCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}" Margin="12,0,4,0"/>
                    <Button Content="â†ª Redo" Command="{Binding RedoCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}" Margin="0,0,12,0"/>
                    
                    <Separator Style="{StaticResource VerticalSeparatorStyle}"/>
                    
                    <Button Content="ðŸ“¥ Insert" Command="{Binding InsertAtPlayheadCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}" Margin="12,0,4,0"
                            ToolTip="Insert selected media at playhead (V) - pushes clips right"/>
                    <Button Content="âœ‚ Split" Command="{Binding SplitClipCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}" Margin="0,0,4,0"
                            ToolTip="Split clip at playhead (S)"/>
                    <Button Content="ðŸ—‘ Delete" Command="{Binding DeleteClipCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}" Margin="0,0,4,0"
                            ToolTip="Delete selected clip or clip at playhead (Del)"/>
                    <Button Content="ðŸ“‹ Duplicate" Command="{Binding DuplicateClipCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}" Margin="0,0,4,0"/>
                    <Button Content="ðŸŽ­ + Overlay" Command="{Binding AddAsOverlayCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}" Margin="0,0,4,0"
                            ToolTip="Add overlay at playhead position"/>
                    <Button Content="ðŸ“ Text" Command="{Binding AddTextClipCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}" Margin="0,0,4,0"
                            ToolTip="Add text/title clip (T)"/>
                    <Button Content="ðŸ“¦ Proxy" Command="{Binding GenerateProxyCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}" Margin="0,0,12,0"
                            ToolTip="Generate proxy for selected media"/>
                </StackPanel>

                <!-- Right tools -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                    <Button Content="ðŸŽµ Detect Beats" Command="{Binding DetectBeatsCommand}" 
                            Style="{StaticResource AccentButtonStyle}" Margin="0,0,4,0"/>
                    <Button Content="ðŸ”„ Beat Sync" Command="{Binding ApplyBeatSyncCommand}" 
                            Style="{StaticResource AccentButtonStyle}" Margin="0,0,4,0"/>
                    <Button Content="ðŸ’¬ Auto Caption" Command="{Binding GenerateCaptionsCommand}" 
                            Style="{StaticResource AccentButtonStyle}" Margin="0,0,12,0"/>
                    
                    <Separator Style="{StaticResource VerticalSeparatorStyle}"/>
                    
                    <!-- Export with presets -->
                    <StackPanel Orientation="Horizontal" Margin="12,0,0,0">
                        <ComboBox ItemsSource="{Binding AvailableExportPresets}"
                                  SelectedItem="{Binding SelectedExportPreset}"
                                  DisplayMemberPath="Name"
                                  Width="150" Margin="0,0,4,0"
                                  ToolTip="Select export preset (YouTube, TikTok, ProRes, etc.)">
                            <ComboBox.GroupStyle>
                                <GroupStyle>
                                    <GroupStyle.HeaderTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="#0EA5E9"/>
                                        </DataTemplate>
                                    </GroupStyle.HeaderTemplate>
                                </GroupStyle>
                            </ComboBox.GroupStyle>
                        </ComboBox>
                        <Button Content="ðŸ“¤ Export" Command="{Binding ExportWithPresetCommand}" 
                                Style="{StaticResource PrimaryButtonStyle}"
                                ToolTip="{Binding SelectedExportPreset.Description}"/>
                    </StackPanel>
                </StackPanel>
                
                <StackPanel/>
            </DockPanel>
        </Border>

        <!-- Main content area -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="180" MinWidth="150"/>
                <ColumnDefinition Width="*" MinWidth="400"/>
                <ColumnDefinition Width="280"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel - Media Library -->
            <Border Grid.Column="0" Background="#4B5058" Margin="0,0,1,0">
                <DockPanel>
                    <Border DockPanel.Dock="Top" Background="#5B616A" Padding="12,8">
                        <StackPanel>
                            <DockPanel>
                                <TextBlock Text="Media Library" FontWeight="SemiBold" 
                                           Foreground="White" VerticalAlignment="Center"/>
                                <Button DockPanel.Dock="Right" Content="+ Import" 
                                        Command="{Binding ImportMediaCommand}"
                                        Style="{StaticResource SmallButtonStyle}"/>
                            </DockPanel>
                            <!-- Quick action buttons -->
                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                <Button Content="ðŸ–¼ Background" 
                                        Command="{Binding ImportBackgroundCommand}"
                                        Style="{StaticResource SmallButtonStyle}" 
                                        FontSize="10" Padding="6,4" Margin="0,0,4,0"
                                        ToolTip="Import background image/video"/>
                                <Button Content="ðŸŽ­ Overlay" 
                                        Command="{Binding AddAsOverlayCommand}"
                                        Style="{StaticResource SmallButtonStyle}" 
                                        FontSize="10" Padding="6,4" Margin="0,0,4,0"
                                        ToolTip="Add selected as overlay"/>
                                <Button Content="âž• Track" 
                                        Command="{Binding AddTrackCommand}"
                                        CommandParameter="video"
                                        Style="{StaticResource SmallButtonStyle}" 
                                        FontSize="10" Padding="6,4"
                                        ToolTip="Add new track"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                    
                    <!-- Tip for drag and drop -->
                    <Border DockPanel.Dock="Top" Background="#3B3F47" Padding="8,4">
                        <TextBlock Text="ðŸ’¡ Drag items to timeline or right-click for options" 
                                   Foreground="#9CA3AF" FontSize="10" TextWrapping="Wrap"/>
                    </Border>
                    
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding MediaLibrary}"
                                      ItemTemplate="{StaticResource MediaAssetTemplate}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </ScrollViewer>
                </DockPanel>
            </Border>

            <!-- Center - Preview -->
            <Grid Grid.Column="1" Background="#3B3F47">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Video Preview - Simple layout like Video Player -->
                <Border Grid.Row="0" Background="Black" Margin="5" CornerRadius="4">
                    <Grid>
                        <!-- LibVLC VideoView for universal video playback - fills available space -->
                        <vlc:VideoView x:Name="VlcVideoView" Background="Black" MinWidth="320" MinHeight="180"/>
                        
                        <!-- Overlay image layer - displayed on top of VLC for image overlays -->
                        <Image x:Name="OverlayImage"
                               Stretch="Uniform"
                               Visibility="Collapsed"
                               IsHitTestVisible="False"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"/>
                        
                        <!-- Legacy MediaElement (hidden, kept for compatibility) -->
                        <MediaElement x:Name="PreviewMediaElement"
                                      LoadedBehavior="Manual"
                                      UnloadedBehavior="Stop"
                                      ScrubbingEnabled="True"
                                      Stretch="Uniform"
                                      Volume="{Binding MasterVolume}"
                                      Visibility="Collapsed"
                                      MediaOpened="PreviewMediaElement_MediaOpened"
                                      MediaEnded="PreviewMediaElement_MediaEnded"
                                      MediaFailed="PreviewMediaElement_MediaFailed"/>
                        
                        <!-- FFmpeg-extracted frame preview (for non-MP4 formats) - on top when visible -->
                        <Image x:Name="PreviewFrameImage"
                               Stretch="Uniform"
                               Visibility="Collapsed"
                               IsHitTestVisible="False"/>
                        
                        <!-- FFmpeg not found warning -->
                        <Border x:Name="FFmpegWarningBorder" 
                                Visibility="Collapsed"
                                Background="#80000000" CornerRadius="8"
                                HorizontalAlignment="Center" VerticalAlignment="Center"
                                Padding="20,15">
                            <StackPanel HorizontalAlignment="Center">
                                <TextBlock Text="âš ï¸ FFmpeg Required" 
                                           Foreground="#FBBF24" FontSize="16" FontWeight="Bold"
                                           HorizontalAlignment="Center" Margin="0,0,0,8"/>
                                <TextBlock Text="Install FFmpeg and add to PATH for video preview" 
                                           Foreground="White" FontSize="12"
                                           HorizontalAlignment="Center"/>
                            </StackPanel>
                        </Border>
                        
                        <!-- Placeholder when no media -->
                        <TextBlock Text="â–¶ Preview" 
                                   Foreground="#555" 
                                   HorizontalAlignment="Center" 
                                   VerticalAlignment="Center"
                                   FontSize="28"
                                   Visibility="{Binding PreviewSource, Converter={StaticResource InverseNullToVisibilityConverter}}"/>
                        
                        <!-- Caption overlay -->
                        <TextBlock Text="{Binding CurrentCaption}" 
                                   Foreground="White" FontSize="20"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Bottom"
                                   Margin="0,0,0,40">
                            <TextBlock.Effect>
                                <DropShadowEffect Color="Black" BlurRadius="4" 
                                                  ShadowDepth="2"/>
                            </TextBlock.Effect>
                        </TextBlock>
                    </Grid>
                </Border>

                <!-- Transport controls - simplified -->
                <Border Grid.Row="1" Background="#4B5058" Padding="4">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <!-- Time display -->
                        <TextBlock Text="{Binding CurrentTimeText}" 
                                   Foreground="White" FontFamily="Consolas" FontSize="11"
                                   VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="/" Foreground="#9CA3AF" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding DurationText}" 
                                   Foreground="#9CA3AF" FontFamily="Consolas" FontSize="11"
                                   VerticalAlignment="Center" Margin="4,0,8,0"/>
                        
                        <!-- Core transport buttons -->
                        <Button Content="â®" Command="{Binding SkipPreviousCommand}"
                                Style="{StaticResource TransportButtonStyle}" 
                                ToolTip="Start (Home)" Width="28" Height="28" FontSize="12"/>
                        <Button Content="â—€" Command="{Binding PreviousFrameCommand}"
                                Style="{StaticResource TransportButtonStyle}" 
                                ToolTip="Previous Frame (â†)" Width="28" Height="28" FontSize="12"/>
                        
                        <!-- Large Play/Pause button -->
                        <Button Command="{Binding PlayPauseCommand}"
                                ToolTip="Play/Pause (Space)" Width="44" Height="32" Margin="2,0">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="#0EA5E9"/>
                                    <Setter Property="Foreground" Value="White"/>
                                    <Setter Property="BorderBrush" Value="#38BDF8"/>
                                    <Setter Property="BorderThickness" Value="1"/>
                                    <Setter Property="Cursor" Value="Hand"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}"
                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                        BorderThickness="{TemplateBinding BorderThickness}"
                                                        CornerRadius="4">
                                                    <ContentPresenter HorizontalAlignment="Center" 
                                                                      VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#38BDF8"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                            <TextBlock Text="{Binding IsPlaying, Converter={StaticResource PlayPauseConverter}}"
                                       FontSize="18"/>
                        </Button>
                        
                        <Button Content="â–¶" Command="{Binding NextFrameCommand}"
                                Style="{StaticResource TransportButtonStyle}" 
                                ToolTip="Next Frame (â†’)" Width="28" Height="28" FontSize="12"/>
                        <Button Content="â­" Command="{Binding SkipNextCommand}"
                                Style="{StaticResource TransportButtonStyle}" 
                                ToolTip="End (End)" Width="28" Height="28" FontSize="12"/>
                        <Button Content="â¹" Command="{Binding StopCommand}"
                                Style="{StaticResource TransportButtonStyle}" 
                                ToolTip="Stop (S)" Width="28" Height="28" FontSize="12"/>
                    </StackPanel>
                </Border>
            </Grid>

            <!-- Right Panel - Properties/Inspector -->
            <Border Grid.Column="2" Background="#4B5058" Margin="1,0,0,0">
                <DockPanel>
                    <Border DockPanel.Dock="Top" Background="#5B616A" Padding="12,8">
                        <TextBlock Text="Inspector" FontWeight="SemiBold" Foreground="White"/>
                    </Border>

                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="12" Visibility="{Binding HasSelectedClip, Converter={StaticResource BoolToVisibilityConverter}}">
                            <!-- Clip properties -->
                            <TextBlock Text="ðŸ“Ž Clip Properties" FontWeight="SemiBold" 
                                       Foreground="White" Margin="0,0,0,8"/>
                            
                            <StackPanel Margin="0,0,0,12">
                                <TextBlock Text="Name" Foreground="#D1D5DB" FontSize="11"/>
                                <TextBox Text="{Binding SelectedClip.Name, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource DarkTextBoxStyle}"/>
                            </StackPanel>

                            <!-- Duration Controls -->
                            <TextBlock Text="â± Duration" FontWeight="SemiBold" 
                                       Foreground="White" Margin="0,0,0,8"/>
                            
                            <DockPanel Margin="0,0,0,8">
                                <TextBlock Text="{Binding SelectedClip.Duration, Converter={StaticResource TimeSpanFormatConverter}}" 
                                           Foreground="#0EA5E9" VerticalAlignment="Center" FontFamily="Consolas"/>
                            </DockPanel>
                            
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                                <Button Content="âˆ’1s" Command="{Binding TrimClipCommand}" CommandParameter="1"
                                        Style="{StaticResource SmallButtonStyle}" Padding="8,3" Margin="0,0,4,0"
                                        ToolTip="Trim 1 second from end"/>
                                <Button Content="âˆ’0.5s" Command="{Binding TrimClipCommand}" CommandParameter="0.5"
                                        Style="{StaticResource SmallButtonStyle}" Padding="8,3" Margin="0,0,8,0"
                                        ToolTip="Trim 0.5 seconds from end"/>
                                <Button Content="+0.5s" Command="{Binding ExtendClipCommand}" CommandParameter="0.5"
                                        Style="{StaticResource SmallButtonStyle}" Padding="8,3" Margin="0,0,4,0"
                                        ToolTip="Extend by 0.5 seconds"/>
                                <Button Content="+1s" Command="{Binding ExtendClipCommand}" CommandParameter="1"
                                        Style="{StaticResource SmallButtonStyle}" Padding="8,3"
                                        ToolTip="Extend by 1 second"/>
                            </StackPanel>

                            <Separator Background="#6B7280" Margin="0,8"/>

                            <!-- Speed Controls -->
                            <TextBlock Text="â± Speed" FontWeight="SemiBold" 
                                       Foreground="White" Margin="0,8,0,8"/>
                            
                            <StackPanel Margin="0,0,0,8">
                                <Slider Minimum="0.1" Maximum="4" 
                                        Value="{Binding SelectedClip.Speed}"
                                        Style="{StaticResource DarkSliderStyle}"/>
                                <TextBlock Text="{Binding SelectedClip.Speed, StringFormat='{}{0:F2}x'}" 
                                           Foreground="White" HorizontalAlignment="Center" Margin="0,4,0,0"/>
                            </StackPanel>
                            
                            <!-- Speed presets -->
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <Button Content="0.25x" Tag="0.25" Click="SpeedPreset_Click"
                                        Style="{StaticResource SmallButtonStyle}" Padding="6,3" Margin="0,0,4,0"/>
                                <Button Content="0.5x" Tag="0.5" Click="SpeedPreset_Click"
                                        Style="{StaticResource SmallButtonStyle}" Padding="6,3" Margin="0,0,4,0"/>
                                <Button Content="1x" Tag="1" Click="SpeedPreset_Click"
                                        Style="{StaticResource SmallButtonStyle}" Padding="6,3" Margin="0,0,4,0"/>
                                <Button Content="1.5x" Tag="1.5" Click="SpeedPreset_Click"
                                        Style="{StaticResource SmallButtonStyle}" Padding="6,3" Margin="0,0,4,0"/>
                                <Button Content="2x" Tag="2" Click="SpeedPreset_Click"
                                        Style="{StaticResource SmallButtonStyle}" Padding="6,3"/>
                            </StackPanel>

                            <Separator Background="#6B7280" Margin="0,8"/>

                            <!-- Audio Controls -->
                            <TextBlock Text="ðŸ”Š Audio" FontWeight="SemiBold" 
                                       Foreground="White" Margin="0,8,0,8"/>

                            <StackPanel Margin="0,0,0,8">
                                <DockPanel>
                                    <TextBlock Text="Volume" Foreground="#D1D5DB" FontSize="11"/>
                                    <TextBlock DockPanel.Dock="Right" 
                                               Text="{Binding SelectedClip.Volume, StringFormat='{}{0:P0}'}" 
                                               Foreground="#0EA5E9" FontSize="11" FontWeight="SemiBold"/>
                                </DockPanel>
                                <Slider Minimum="0" Maximum="2" 
                                        Value="{Binding SelectedClip.Volume}"
                                        Style="{StaticResource DarkSliderStyle}"/>
                            </StackPanel>
                            
                            <!-- Volume presets -->
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <Button Content="ðŸ”‡ Mute" Tag="0" Click="VolumePreset_Click"
                                        Style="{StaticResource SmallButtonStyle}" Padding="6,3" Margin="0,0,4,0"/>
                                <Button Content="50%" Tag="0.5" Click="VolumePreset_Click"
                                        Style="{StaticResource SmallButtonStyle}" Padding="6,3" Margin="0,0,4,0"/>
                                <Button Content="100%" Tag="1" Click="VolumePreset_Click"
                                        Style="{StaticResource SmallButtonStyle}" Padding="6,3" Margin="0,0,4,0"/>
                                <Button Content="150%" Tag="1.5" Click="VolumePreset_Click"
                                        Style="{StaticResource SmallButtonStyle}" Padding="6,3" Margin="0,0,4,0"/>
                                <Button Content="200%" Tag="2" Click="VolumePreset_Click"
                                        Style="{StaticResource SmallButtonStyle}" Padding="6,3"/>
                            </StackPanel>

                            <!-- Audio Fade -->
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition/>
                                    <ColumnDefinition/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Margin="0,0,4,0">
                                    <TextBlock Text="Fade In (sec)" Foreground="#D1D5DB" FontSize="11"/>
                                    <TextBox Text="{Binding SelectedClip.AudioFadeInSeconds, StringFormat=F1, UpdateSourceTrigger=LostFocus}"
                                             Style="{StaticResource DarkTextBoxStyle}"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Margin="4,0,0,0">
                                    <TextBlock Text="Fade Out (sec)" Foreground="#D1D5DB" FontSize="11"/>
                                    <TextBox Text="{Binding SelectedClip.AudioFadeOutSeconds, StringFormat=F1, UpdateSourceTrigger=LostFocus}"
                                             Style="{StaticResource DarkTextBoxStyle}"/>
                                </StackPanel>
                            </Grid>

                            <Separator Background="#6B7280" Margin="0,8"/>

                            <!-- Opacity -->
                            <TextBlock Text="ðŸ‘ Opacity" FontWeight="SemiBold" 
                                       Foreground="White" Margin="0,8,0,8"/>
                            
                            <StackPanel Margin="0,0,0,8">
                                <Slider Minimum="0" Maximum="1" 
                                        Value="{Binding SelectedClip.Opacity}"
                                        Style="{StaticResource DarkSliderStyle}"/>
                                <TextBlock Text="{Binding SelectedClip.Opacity, StringFormat='{}{0:P0}'}" 
                                           Foreground="White" HorizontalAlignment="Center"/>
                            </StackPanel>

                            <Separator Background="#6B7280" Margin="0,8"/>

                            <!-- Background Removal -->
                            <TextBlock Text="ðŸŽ­ Background" FontWeight="SemiBold" 
                                       Foreground="White" Margin="0,8,0,8"/>
                            
                            <Button Content="âœ¨ Remove Background" 
                                    Command="{Binding RemoveBackgroundCommand}"
                                    Style="{StaticResource AccentButtonStyle}"
                                    Margin="0,0,0,8"/>
                            
                            <TextBlock Text="Removes background using AI (processed on export)" 
                                       Foreground="#9CA3AF" FontSize="10" TextWrapping="Wrap"/>

                            <Separator Background="#6B7280" Margin="0,8"/>

                            <!-- Shotcut-Style Filters (100+ filters) -->
                            <Expander IsExpanded="True" Foreground="White">
                                <Expander.Header>
                                    <TextBlock Text="ðŸŽ¨ Filters (100+)" FontWeight="SemiBold" Foreground="White"/>
                                </Expander.Header>
                                <StackPanel Margin="0,8,0,0">
                                    <!-- Filter search -->
                                    <TextBox Text="{Binding FilterSearchText, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource DarkTextBoxStyle}"
                                             Tag="ðŸ” Search filters..." Margin="0,0,0,8"/>
                                    
                                    <!-- Filter categories -->
                                    <ItemsControl ItemsSource="{Binding FiltersByCategory}" MaxHeight="200">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Expander IsExpanded="False" Foreground="White" Margin="0,2">
                                                    <Expander.Header>
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding Icon}" FontSize="12" Margin="0,0,4,0"/>
                                                            <TextBlock Text="{Binding CategoryName}" FontSize="11" FontWeight="SemiBold"/>
                                                            <TextBlock Text="{Binding Filters.Count, StringFormat=' ({0})'}" 
                                                                       Foreground="#9CA3AF" FontSize="10" VerticalAlignment="Center"/>
                                                        </StackPanel>
                                                    </Expander.Header>
                                                    <ItemsControl ItemsSource="{Binding Filters}" Margin="12,4,0,0">
                                                        <ItemsControl.ItemsPanel>
                                                            <ItemsPanelTemplate>
                                                                <WrapPanel/>
                                                            </ItemsPanelTemplate>
                                                        </ItemsControl.ItemsPanel>
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate>
                                                                <Button Command="{Binding DataContext.ApplyShotcutFilterCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                        CommandParameter="{Binding}"
                                                                        Style="{StaticResource SmallButtonStyle}"
                                                                        Padding="5,2" Margin="1"
                                                                        ToolTip="{Binding Description}">
                                                                    <StackPanel Orientation="Horizontal">
                                                                        <TextBlock Text="{Binding Icon}" FontSize="10" Margin="0,0,3,0"/>
                                                                        <TextBlock Text="{Binding Name}" FontSize="10"/>
                                                                    </StackPanel>
                                                                </Button>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                </Expander>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Expander>

                            <!-- Applied Shotcut Filters -->
                            <TextBlock Text="Applied Filters:" Foreground="#D1D5DB" FontSize="11" Margin="0,8,0,4"/>
                            <ItemsControl ItemsSource="{Binding SelectedClip.Filters}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="#3B3F47" CornerRadius="4" Padding="6,4" Margin="0,2"
                                                Opacity="{Binding IsEnabled, Converter={StaticResource BoolToOpacityConverter}}">
                                            <DockPanel>
                                                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                                                    <Button Content="â–²" 
                                                            Command="{Binding DataContext.MoveFilterUpCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            CommandParameter="{Binding}"
                                                            Style="{StaticResource SmallButtonStyle}" Padding="3,0" FontSize="8"/>
                                                    <Button Content="â–¼" 
                                                            Command="{Binding DataContext.MoveFilterDownCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            CommandParameter="{Binding}"
                                                            Style="{StaticResource SmallButtonStyle}" Padding="3,0" FontSize="8"/>
                                                    <ToggleButton IsChecked="{Binding IsEnabled, Mode=TwoWay}" 
                                                                  Style="{StaticResource TrackToggleButtonStyle}"
                                                                  Width="22" Height="18" Margin="2,0"
                                                                  ToolTip="Enable/Disable Filter">
                                                        <TextBlock Text="ðŸ‘" FontSize="9"/>
                                                    </ToggleButton>
                                                    <Button Content="âœ•" 
                                                            Command="{Binding DataContext.RemoveShotcutFilterCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            CommandParameter="{Binding}"
                                                            Background="Transparent" Foreground="#EF4444" 
                                                            BorderThickness="0" Padding="4,0" Cursor="Hand" FontSize="10"/>
                                                </StackPanel>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="{Binding Icon}" FontSize="10" Margin="0,0,4,0"/>
                                                    <TextBlock Text="{Binding Name}" Foreground="White" FontSize="11"/>
                                                </StackPanel>
                                            </DockPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- Legacy Filters (kept for compatibility) -->
                            <Expander IsExpanded="False" Foreground="White" Margin="0,8,0,0">
                                <Expander.Header>
                                    <TextBlock Text="Quick Filters" FontSize="11" Foreground="#9CA3AF"/>
                                </Expander.Header>
                                <ItemsControl ItemsSource="{Binding AvailableFilters}" Margin="0,4,0,0">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Button Content="{Binding Name}" 
                                                    Command="{Binding DataContext.ApplyFilterCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}"
                                                    Style="{StaticResource SmallButtonStyle}"
                                                    Padding="6,3" Margin="2"
                                                    ToolTip="{Binding Category}"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Expander>

                            <!-- Legacy Applied Filters -->
                            <ItemsControl ItemsSource="{Binding SelectedClip.Effects}" Margin="0,4,0,0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="#3B3F47" CornerRadius="4" Padding="6,4" Margin="0,2">
                                            <DockPanel>
                                                <Button DockPanel.Dock="Right" Content="âœ•" 
                                                        Command="{Binding DataContext.RemoveFilterCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"
                                                        Background="Transparent" Foreground="#EF4444" 
                                                        BorderThickness="0" Padding="4,0" Cursor="Hand"/>
                                                <TextBlock Text="{Binding Name}" Foreground="White" FontSize="11"/>
                                            </DockPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <Separator Background="#6B7280" Margin="0,8"/>

                            <!-- Color Grading -->
                            <TextBlock Text="ðŸŽ¬ Color Grading" FontWeight="SemiBold" 
                                       Foreground="White" Margin="0,8,0,8"/>

                            <StackPanel Margin="0,0,0,8">
                                <TextBlock Text="Brightness" Foreground="#D1D5DB" FontSize="11"/>
                                <Slider Minimum="-1" Maximum="1" 
                                        Value="{Binding SelectedClipColorGrading.Brightness}"
                                        Style="{StaticResource DarkSliderStyle}"/>
                            </StackPanel>

                            <StackPanel Margin="0,0,0,8">
                                <TextBlock Text="Contrast" Foreground="#D1D5DB" FontSize="11"/>
                                <Slider Minimum="0" Maximum="2" 
                                        Value="{Binding SelectedClipColorGrading.Contrast}"
                                        Style="{StaticResource DarkSliderStyle}"/>
                            </StackPanel>

                            <StackPanel Margin="0,0,0,8">
                                <TextBlock Text="Saturation" Foreground="#D1D5DB" FontSize="11"/>
                                <Slider Minimum="0" Maximum="2" 
                                        Value="{Binding SelectedClipColorGrading.Saturation}"
                                        Style="{StaticResource DarkSliderStyle}"/>
                            </StackPanel>

                            <StackPanel Margin="0,0,0,8">
                                <TextBlock Text="Temperature" Foreground="#D1D5DB" FontSize="11"/>
                                <Slider Minimum="-1" Maximum="1" 
                                        Value="{Binding SelectedClipColorGrading.Temperature}"
                                        Style="{StaticResource DarkSliderStyle}"/>
                            </StackPanel>

                            <Separator Background="#6B7280" Margin="0,8"/>

                            <!-- Transform -->
                            <TextBlock Text="ðŸ“ Transform" FontWeight="SemiBold" 
                                       Foreground="White" Margin="0,8,0,8"/>

                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition/>
                                    <ColumnDefinition/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Margin="0,0,4,0">
                                    <TextBlock Text="Position X" Foreground="#D1D5DB" FontSize="11"/>
                                    <TextBox Text="{Binding SelectedClipTransform.X}" 
                                             Style="{StaticResource DarkTextBoxStyle}"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Margin="4,0,0,0">
                                    <TextBlock Text="Position Y" Foreground="#D1D5DB" FontSize="11"/>
                                    <TextBox Text="{Binding SelectedClipTransform.Y}" 
                                             Style="{StaticResource DarkTextBoxStyle}"/>
                                </StackPanel>
                            </Grid>

                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition/>
                                    <ColumnDefinition/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Margin="0,0,4,0">
                                    <TextBlock Text="Scale" Foreground="#D1D5DB" FontSize="11"/>
                                    <Slider Minimum="0.1" Maximum="4" 
                                            Value="{Binding SelectedClipTransform.Scale}"
                                            Style="{StaticResource DarkSliderStyle}"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Margin="4,0,0,0">
                                    <TextBlock Text="Rotation" Foreground="#D1D5DB" FontSize="11"/>
                                    <Slider Minimum="-180" Maximum="180" 
                                            Value="{Binding SelectedClipTransform.Rotation}"
                                            Style="{StaticResource DarkSliderStyle}"/>
                                </StackPanel>
                            </Grid>

                            <Button Content="+ Add Keyframe" 
                                    Command="{Binding AddKeyframeCommand}"
                                    Style="{StaticResource SmallButtonStyle}"
                                    Margin="0,8"/>

                            <Separator Background="#6B7280" Margin="0,8"/>

                            <!-- Transitions -->
                            <TextBlock Text="âœ¨ Transitions" FontWeight="SemiBold" 
                                       Foreground="White" Margin="0,8,0,8"/>

                            <ItemsControl ItemsSource="{Binding AvailableTransitions}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Content="{Binding Name}" 
                                                Command="{Binding DataContext.ApplyTransitionCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"
                                                Style="{StaticResource SmallButtonStyle}"
                                                Margin="2"/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Grid>

        <!-- Splitter -->
        <GridSplitter Grid.Row="2" Height="4" HorizontalAlignment="Stretch" 
                      Background="#6B7280" ResizeDirection="Rows"/>

        <!-- Timeline -->
        <Border Grid.Row="3" Background="#3B3F47">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Timeline header with options -->
                <Border Grid.Row="0" Background="#4B5058" Padding="8,4">
                    <DockPanel>
                        <StackPanel DockPanel.Dock="Left" Orientation="Horizontal">
                            <CheckBox Content="Show Beats" IsChecked="{Binding ShowBeatMarkers}"
                                      Foreground="White" Margin="0,0,12,0"/>
                            <CheckBox Content="Show Waveform" IsChecked="{Binding ShowWaveform}"
                                      Foreground="White" Margin="0,0,12,0"/>
                            <CheckBox Content="Snap to Beats" IsChecked="{Binding SnapToBeats}"
                                      Foreground="White" Margin="0,0,12,0"/>
                            <CheckBox Content="Snap to Clips" IsChecked="{Binding SnapToClips}"
                                      Foreground="White"/>
                        </StackPanel>
                        
                        <TextBlock DockPanel.Dock="Right" 
                                   Text="{Binding Project.Bpm, StringFormat='BPM: {0:F1}'}"
                                   Foreground="#D1D5DB" VerticalAlignment="Center"/>
                    </DockPanel>
                </Border>

                <!-- Timeline tracks area -->
                <Grid Grid.Row="1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="150"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Track headers -->
                    <Grid Grid.Column="0">
                        <!-- Empty space to align with time ruler -->
                        <Rectangle Height="25" VerticalAlignment="Top" Fill="#4B5058"/>
                        
                        <!-- Track headers list - aligned with tracks content (Shotcut-style) -->
                        <ScrollViewer VerticalScrollBarVisibility="Hidden" Margin="0,25,0,0"
                                      x:Name="TrackHeadersScrollViewer">
                            <ItemsControl ItemsSource="{Binding Tracks}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Height="60" 
                                                Background="{Binding Type, Converter={StaticResource TrackTypeToColorConverter}}" 
                                                BorderBrush="#6B7280" BorderThickness="0,0,0,1"
                                                Padding="8,4"
                                                Opacity="{Binding IsLocked, Converter={StaticResource BoolToOpacityConverter}}">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                </Grid.RowDefinitions>
                                                
                                                <!-- Track name -->
                                                <TextBlock Grid.Row="0" Text="{Binding Name}" 
                                                           Foreground="White" FontWeight="SemiBold"
                                                           FontSize="11"/>
                                                
                                                <!-- Track controls (Shotcut-style: Lock, Mute, Hide) -->
                                                <StackPanel Grid.Row="1" Orientation="Horizontal" 
                                                            VerticalAlignment="Center" Margin="0,4,0,0">
                                                    <!-- Lock button -->
                                                    <ToggleButton IsChecked="{Binding IsLocked, Mode=TwoWay}" 
                                                                  Width="22" Height="20" Margin="0,0,3,0"
                                                                  ToolTip="{Binding IsLocked, Converter={StaticResource BoolToLockTooltipConverter}}"
                                                                  Style="{StaticResource TrackToggleButtonStyle}">
                                                        <TextBlock Text="ðŸ”’" FontSize="10"/>
                                                    </ToggleButton>
                                                    
                                                    <!-- Mute button -->
                                                    <ToggleButton IsChecked="{Binding IsMuted, Mode=TwoWay}" 
                                                                  Width="22" Height="20" Margin="0,0,3,0"
                                                                  ToolTip="{Binding IsMuted, Converter={StaticResource BoolToMuteTooltipConverter}}"
                                                                  Style="{StaticResource TrackToggleButtonStyle}">
                                                        <TextBlock Text="M" FontSize="10" FontWeight="Bold"/>
                                                    </ToggleButton>
                                                    
                                                    <!-- Hide/Show button (for video tracks) -->
                                                    <ToggleButton IsChecked="{Binding IsVisible, Mode=TwoWay, Converter={StaticResource InverseBoolConverter}}" 
                                                                  Width="22" Height="20"
                                                                  ToolTip="{Binding IsVisible, Converter={StaticResource BoolToVisibilityTooltipConverter}}"
                                                                  Style="{StaticResource TrackToggleButtonStyle}">
                                                        <TextBlock Text="ðŸ‘" FontSize="10"/>
                                                    </ToggleButton>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>

                    <!-- Timeline canvas with horizontal scrolling -->
                    <ScrollViewer Grid.Column="1" 
                                  HorizontalScrollBarVisibility="Auto" 
                                  VerticalScrollBarVisibility="Auto"
                                  x:Name="TimelineScrollViewer"
                                  PreviewMouseWheel="TimelineScrollViewer_PreviewMouseWheel">
                        <Grid MinWidth="{Binding TimelineWidth}">
                            <!-- Time ruler with click-to-seek and markers -->
                            <Canvas Height="25" Background="#4B5058" 
                                    VerticalAlignment="Top"
                                    MouseLeftButtonDown="TimeRuler_MouseLeftButtonDown"
                                    MouseMove="TimeRuler_MouseMove"
                                    MouseLeftButtonUp="TimeRuler_MouseLeftButtonUp"
                                    Cursor="Hand">
                                
                                <!-- Time markers -->
                                <ItemsControl ItemsSource="{Binding TimelineRulerMarkers}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <Canvas/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemContainerStyle>
                                        <Style>
                                            <Setter Property="Canvas.Left" Value="{Binding Position}"/>
                                        </Style>
                                    </ItemsControl.ItemContainerStyle>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel>
                                                <TextBlock Text="{Binding Label}" 
                                                           Foreground="#D1D5DB" 
                                                           FontSize="9"
                                                           Visibility="{Binding IsMajor, Converter={StaticResource BoolToVisibilityConverter}}"
                                                           Margin="-20,0,0,0"/>
                                                <Rectangle Width="1" 
                                                           Height="{Binding IsMajor, Converter={StaticResource BoolToHeightConverter}}"
                                                           Fill="#9CA3AF"
                                                           VerticalAlignment="Bottom"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                
                                <!-- Playhead top indicator (in ruler) -->
                                <Polygon Points="0,0 12,0 6,10" 
                                         Fill="#F97316" 
                                         Canvas.Left="{Binding CurrentTime, Converter={StaticResource TimeToPixelConverter}}"
                                         Canvas.Top="15"
                                         Margin="-6,0,0,0"
                                         Cursor="SizeWE"/>
                            </Canvas>

                            <!-- Tracks content -->
                            <ItemsControl ItemsSource="{Binding Tracks}" Margin="0,25,0,0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Height="60" Background="#3B3F47" 
                                                BorderBrush="#6B7280" BorderThickness="0,0,0,1"
                                                AllowDrop="True"
                                                Drop="Track_Drop"
                                                DragOver="Track_DragOver">
                                            <Canvas>
                                                <!-- Clips with drag/click support (Shotcut-style) -->
                                                <ItemsControl ItemsSource="{Binding Clips}">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <Canvas/>
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemContainerStyle>
                                                        <Style>
                                                            <Setter Property="Canvas.Left" 
                                                                    Value="{Binding StartPosition, Converter={StaticResource TimeToPixelConverter}}"/>
                                                        </Style>
                                                    </ItemsControl.ItemContainerStyle>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Border Background="{Binding Color}" 
                                                                    Width="{Binding Duration, Converter={StaticResource DurationToWidthConverter}}"
                                                                    Height="50" CornerRadius="3"
                                                                    BorderBrush="#7B8590" BorderThickness="1"
                                                                    Cursor="SizeAll" Margin="0,5"
                                                                    MouseLeftButtonDown="Clip_MouseLeftButtonDown"
                                                                    MouseMove="Clip_MouseMove"
                                                                    MouseLeftButtonUp="Clip_MouseLeftButtonUp"
                                                                    Tag="{Binding}">
                                                                <Border.ContextMenu>
                                                                    <ContextMenu>
                                                                        <MenuItem Header="Delete Clip" 
                                                                                  Command="{Binding DataContext.DeleteClipCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                                                        <MenuItem Header="Split at Playhead"
                                                                                  Command="{Binding DataContext.SplitClipCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                                                        <MenuItem Header="Duplicate"
                                                                                  Command="{Binding DataContext.DuplicateClipCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                                                        <Separator/>
                                                                        <MenuItem Header="Set Preview to This Clip" Click="SetPreviewToClip_Click"/>
                                                                    </ContextMenu>
                                                                </Border.ContextMenu>
                                                                <Grid>
                                                                    <!-- Thumbnail for video clips -->
                                                                    <Image Source="{Binding ThumbnailPath}" 
                                                                           Stretch="UniformToFill" 
                                                                           Opacity="0.3"
                                                                           HorizontalAlignment="Left"
                                                                           Width="60"/>
                                                                    <TextBlock Text="{Binding Name}" 
                                                                               Foreground="White" 
                                                                               FontSize="10"
                                                                               Margin="4,2"
                                                                               TextTrimming="CharacterEllipsis"/>
                                                                    <!-- Waveform display for audio -->
                                                                    <Polyline Points="{Binding WaveformPoints}"
                                                                              Stroke="#80FFFFFF"
                                                                              StrokeThickness="1"
                                                                              VerticalAlignment="Center"/>
                                                                    <!-- Trim handles -->
                                                                    <Rectangle Width="5" HorizontalAlignment="Left" 
                                                                               Fill="#80FFFFFF" Cursor="SizeWE" Opacity="0.5"
                                                                               MouseLeftButtonDown="TrimIn_MouseLeftButtonDown"/>
                                                                    <Rectangle Width="5" HorizontalAlignment="Right" 
                                                                               Fill="#80FFFFFF" Cursor="SizeWE" Opacity="0.5"
                                                                               MouseLeftButtonDown="TrimOut_MouseLeftButtonDown"/>
                                                                </Grid>
                                                            </Border>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>

                                                <!-- Beat markers overlay -->
                                                <ItemsControl ItemsSource="{Binding DataContext.BeatMarkers, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                              Visibility="{Binding DataContext.ShowBeatMarkers, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToVisibilityConverter}}">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <Canvas/>
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemContainerStyle>
                                                        <Style>
                                                            <Setter Property="Canvas.Left" 
                                                                    Value="{Binding Time, Converter={StaticResource TimeToPixelConverter}}"/>
                                                        </Style>
                                                    </ItemsControl.ItemContainerStyle>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Rectangle Width="2" Height="60" 
                                                                       Fill="#F472B6" Opacity="0.8"/>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </Canvas>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- Playhead (draggable) -->
                            <Canvas x:Name="PlayheadCanvas"
                                    MouseLeftButtonDown="Playhead_MouseLeftButtonDown"
                                    MouseMove="Playhead_MouseMove"
                                    MouseLeftButtonUp="Playhead_MouseLeftButtonUp">
                                <Grid Canvas.Left="{Binding CurrentTime, Converter={StaticResource TimeToPixelConverter}}"
                                      Cursor="SizeWE">
                                    <Rectangle Width="3" Height="2000" Fill="#F97316" 
                                               Margin="-1,25,0,0" Opacity="0.9"/>
                                    <!-- Draggable handle area (larger hitbox) -->
                                    <Rectangle Width="15" Height="2000" Fill="Transparent" 
                                               Margin="-7,25,0,0" Cursor="SizeWE"/>
                                </Grid>
                            </Canvas>
                        </Grid>
                    </ScrollViewer>
                </Grid>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border Grid.Row="4" Background="#4B5058" Padding="8,4">
            <DockPanel>
                <!-- Left side: In/Out Points, Markers -->
                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal">
                    <!-- In/Out Points -->
                    <TextBlock Text="In:" Foreground="#9CA3AF" VerticalAlignment="Center" Margin="0,0,4,0"/>
                    <TextBlock Text="{Binding InPoint, StringFormat='{}{0:hh\\:mm\\:ss\\.fff}'}" 
                               Foreground="#38BDF8" VerticalAlignment="Center" FontFamily="Consolas" FontSize="11"/>
                    <TextBlock Text="Out:" Foreground="#9CA3AF" VerticalAlignment="Center" Margin="12,0,4,0"/>
                    <TextBlock Text="{Binding OutPoint, StringFormat='{}{0:hh\\:mm\\:ss\\.fff}'}" 
                               Foreground="#38BDF8" VerticalAlignment="Center" FontFamily="Consolas" FontSize="11"/>
                    
                    <Separator Style="{StaticResource VerticalSeparatorStyle}" Margin="12,0"/>
                    
                    <!-- Markers count -->
                    <TextBlock Text="ðŸš©" Foreground="#F472B6" VerticalAlignment="Center" Margin="0,0,4,0"/>
                    <TextBlock Text="{Binding Markers.Count, StringFormat='{}{0} markers'}" 
                               Foreground="#D1D5DB" VerticalAlignment="Center" FontSize="11"/>
                    
                    <Separator Style="{StaticResource VerticalSeparatorStyle}" Margin="12,0"/>
                    
                    <!-- Loop indicator -->
                    <TextBlock Text="ðŸ”" Foreground="{Binding IsLooping, Converter={StaticResource BoolToColorConverter}}" 
                               VerticalAlignment="Center" FontSize="12"/>
                    <TextBlock Text="Loop" 
                               Foreground="{Binding IsLooping, Converter={StaticResource BoolToColorConverter}}" 
                               VerticalAlignment="Center" Margin="4,0,0,0" FontSize="11"/>
                    
                    <!-- Ripple indicator -->
                    <TextBlock Text="â‡„" Foreground="{Binding RippleEdit, Converter={StaticResource BoolToColorConverter}}" 
                               VerticalAlignment="Center" Margin="12,0,0,0" FontSize="12"/>
                    <TextBlock Text="Ripple" 
                               Foreground="{Binding RippleEdit, Converter={StaticResource BoolToColorConverter}}" 
                               VerticalAlignment="Center" Margin="4,0,0,0" FontSize="11"/>
                    
                    <Separator Style="{StaticResource VerticalSeparatorStyle}" Margin="12,0"/>
                    
                    <!-- Whisper status -->
                    <TextBlock Text="{Binding WhisperStatus}" 
                               Foreground="{Binding IsWhisperAvailable, Converter={StaticResource BoolToColorConverter}}"
                               VerticalAlignment="Center" FontSize="11" Margin="0,0,8,0"/>
                    
                    <Button Content="ðŸ“¥ Install Whisper" 
                            Command="{Binding InstallWhisperCommand}"
                            Visibility="{Binding IsWhisperAvailable, Converter={StaticResource InverseBoolToVisibilityConverter}}"
                            Style="{StaticResource SmallButtonStyle}" Margin="0,0,4,0"
                            ToolTip="Download and install whisper.cpp for auto-captions" FontSize="10"/>
                </StackPanel>
                
                <!-- Right side: Status and progress -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                    <TextBlock Text="{Binding StatusMessage}" 
                               Foreground="#D1D5DB" VerticalAlignment="Center" FontSize="11"/>
                    
                    <ProgressBar Width="150" Height="10"
                                 Value="{Binding Progress}" Maximum="1"
                                 Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}"
                                 Margin="12,0,0,0"/>
                    
                    <Button Content="Cancel" 
                            Command="{Binding CancelOperationCommand}"
                            Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}"
                            Style="{StaticResource SmallButtonStyle}" Margin="4,0,0,0" FontSize="10"/>
                    
                    <!-- Debug Log Toggle -->
                    <CheckBox Content="ðŸ” Debug" 
                              IsChecked="{Binding ShowDebugLog}"
                              Foreground="#D1D5DB"
                              VerticalAlignment="Center"
                              Margin="8,0,0,0" FontSize="10"
                              ToolTip="Toggle debug log panel"/>
                </StackPanel>
                
                <StackPanel/>
            </DockPanel>
        </Border>
        
        <!-- Debug Log Panel (Overlay at bottom) -->
        <Border Grid.Row="1" 
                Background="#1a1a1a" 
                BorderBrush="#F97316" 
                BorderThickness="0,2,0,0"
                MaxHeight="200"
                VerticalAlignment="Bottom"
                Visibility="{Binding ShowDebugLog, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <DockPanel Grid.Row="0" Background="#2d2d2d">
                    <TextBlock Text="ðŸ” Debug Log" Foreground="#F97316" FontWeight="Bold" 
                               VerticalAlignment="Center" Margin="8,4"/>
                    <Button Content="Clear" 
                            Command="{Binding ClearDebugLogCommand}"
                            Style="{StaticResource SmallButtonStyle}" 
                            DockPanel.Dock="Right" Margin="4" FontSize="10"/>
                    <StackPanel/>
                </DockPanel>
                
                <ScrollViewer Grid.Row="1" 
                              VerticalScrollBarVisibility="Auto" 
                              HorizontalScrollBarVisibility="Auto"
                              x:Name="DebugLogScrollViewer">
                    <TextBox Text="{Binding DebugLog, Mode=OneWay}" 
                             IsReadOnly="True"
                             Background="Transparent"
                             Foreground="#00FF00"
                             FontFamily="Consolas"
                             FontSize="11"
                             BorderThickness="0"
                             TextWrapping="NoWrap"
                             AcceptsReturn="True"/>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</UserControl>
