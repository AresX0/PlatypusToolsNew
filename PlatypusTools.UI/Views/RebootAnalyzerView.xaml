<UserControl x:Class="PlatypusTools.UI.Views.RebootAnalyzerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:PlatypusTools.UI.ViewModels">
    <UserControl.DataContext>
        <vm:RebootAnalyzerViewModel/>
    </UserControl.DataContext>
    
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="5"/>
            <RowDefinition Height="*" MinHeight="200"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,15">
            <TextBlock Text="ðŸ”„ Reboot Analyzer" FontSize="24" FontWeight="Bold" Margin="0,0,0,5"/>
            <TextBlock Text="Analyze unexpected reboots, crashes, and blue screens to identify root causes and solutions." 
                       Foreground="Gray" TextWrapping="Wrap"/>
        </StackPanel>

        <!-- Controls -->
        <GroupBox Header="Analysis Controls" Grid.Row="1" Margin="0,0,0,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Analyze last:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                    <ComboBox x:Name="DaysComboBox" Width="80" SelectedIndex="1"
                              SelectionChanged="DaysComboBox_SelectionChanged">
                        <ComboBoxItem Content="7 days"/>
                        <ComboBoxItem Content="30 days"/>
                        <ComboBoxItem Content="90 days"/>
                        <ComboBoxItem Content="365 days"/>
                    </ComboBox>
                </StackPanel>

                <Button Grid.Column="1" Content="ðŸ” Analyze Reboots" Command="{Binding AnalyzeCommand}" 
                        MinWidth="180" Height="35" Margin="20,0,0,0"
                        Background="#FF2196F3" Foreground="White" FontWeight="Bold"
                        IsEnabled="{Binding IsNotAnalyzing}"/>

                <Button Grid.Column="2" Content="ðŸ—‘ï¸ Clear" Command="{Binding ClearCommand}" 
                        MinWidth="180" Height="35" Margin="10,0,0,0"
                        IsEnabled="{Binding IsNotAnalyzing}"/>

                <TextBlock Grid.Column="3" Text="{Binding StatusMessage}" 
                           VerticalAlignment="Center" Margin="20,0,0,0" Foreground="Gray"/>

                <ProgressBar Grid.Column="4" Width="150" Height="20" IsIndeterminate="True"
                             Visibility="{Binding IsAnalyzing, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </Grid>
        </GroupBox>

        <!-- Summary Cards -->
        <GroupBox Header="Summary" Grid.Row="2" Margin="0,0,0,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- System Uptime -->
                <Border Grid.Column="0" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" 
                        CornerRadius="5" Padding="10" Margin="0,0,5,0" Background="{DynamicResource CardBackgroundBrush}">
                    <StackPanel HorizontalAlignment="Center">
                        <TextBlock Text="â±ï¸" FontSize="24" HorizontalAlignment="Center"/>
                        <TextBlock Text="System Uptime" FontSize="11" Foreground="Gray" HorizontalAlignment="Center"/>
                        <TextBlock Text="{Binding SystemUptime}" FontSize="16" FontWeight="Bold" HorizontalAlignment="Center"/>
                    </StackPanel>
                </Border>

                <!-- Unexpected Reboots -->
                <Border Grid.Column="1" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" 
                        CornerRadius="5" Padding="10" Margin="5,0" Background="#FFF44336">
                    <StackPanel HorizontalAlignment="Center">
                        <TextBlock Text="âš ï¸" FontSize="24" HorizontalAlignment="Center" Foreground="White"/>
                        <TextBlock Text="Unexpected Reboots" FontSize="11" Foreground="White" HorizontalAlignment="Center"/>
                        <TextBlock Text="{Binding UnexpectedRebootCount}" FontSize="20" FontWeight="Bold" 
                                   HorizontalAlignment="Center" Foreground="White"/>
                    </StackPanel>
                </Border>

                <!-- BSODs -->
                <Border Grid.Column="2" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" 
                        CornerRadius="5" Padding="10" Margin="5,0" Background="#FF9C27B0">
                    <StackPanel HorizontalAlignment="Center">
                        <TextBlock Text="ðŸ’¥" FontSize="24" HorizontalAlignment="Center" Foreground="White"/>
                        <TextBlock Text="Blue Screens" FontSize="11" Foreground="White" HorizontalAlignment="Center"/>
                        <TextBlock Text="{Binding BSODCount}" FontSize="20" FontWeight="Bold" 
                                   HorizontalAlignment="Center" Foreground="White"/>
                    </StackPanel>
                </Border>

                <!-- App Crashes -->
                <Border Grid.Column="3" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" 
                        CornerRadius="5" Padding="10" Margin="5,0" Background="#FFFF9800">
                    <StackPanel HorizontalAlignment="Center">
                        <TextBlock Text="ðŸ“±" FontSize="24" HorizontalAlignment="Center" Foreground="White"/>
                        <TextBlock Text="App Crashes" FontSize="11" Foreground="White" HorizontalAlignment="Center"/>
                        <TextBlock Text="{Binding AppCrashCount}" FontSize="20" FontWeight="Bold" 
                                   HorizontalAlignment="Center" Foreground="White"/>
                    </StackPanel>
                </Border>

                <!-- Crash Dumps -->
                <Border Grid.Column="4" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" 
                        CornerRadius="5" Padding="10" Margin="5,0" Background="#FF607D8B">
                    <StackPanel HorizontalAlignment="Center">
                        <TextBlock Text="ðŸ“" FontSize="24" HorizontalAlignment="Center" Foreground="White"/>
                        <TextBlock Text="Crash Dumps" FontSize="11" Foreground="White" HorizontalAlignment="Center"/>
                        <TextBlock Text="{Binding CrashDumpCount}" FontSize="20" FontWeight="Bold" 
                                   HorizontalAlignment="Center" Foreground="White"/>
                    </StackPanel>
                </Border>

                <!-- Clean Shutdowns -->
                <Border Grid.Column="5" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" 
                        CornerRadius="5" Padding="10" Margin="5,0,0,0" Background="#FF4CAF50">
                    <StackPanel HorizontalAlignment="Center">
                        <TextBlock Text="âœ…" FontSize="24" HorizontalAlignment="Center" Foreground="White"/>
                        <TextBlock Text="Clean Shutdowns" FontSize="11" Foreground="White" HorizontalAlignment="Center"/>
                        <TextBlock Text="{Binding CleanShutdownCount}" FontSize="20" FontWeight="Bold" 
                                   HorizontalAlignment="Center" Foreground="White"/>
                    </StackPanel>
                </Border>
            </Grid>
        </GroupBox>

        <!-- GridSplitter -->
        <GridSplitter Grid.Row="3" Height="5" HorizontalAlignment="Stretch" 
                      Background="#CCCCCC" Cursor="SizeNS" ResizeDirection="Rows"/>

        <!-- Results Tabs -->
        <TabControl Grid.Row="4" Margin="0,5,0,0">
            <!-- Unexpected Reboots Tab -->
            <TabItem Header="âš ï¸ Unexpected Reboots">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <DataGrid Grid.Row="0" ItemsSource="{Binding UnexpectedReboots}" AutoGenerateColumns="False" 
                              IsReadOnly="True" CanUserAddRows="False" SelectedItem="{Binding SelectedEvent}"
                              SelectionMode="Single">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Time" Binding="{Binding TimeStamp, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" Width="150"/>
                            <DataGridTextColumn Header="Type" Binding="{Binding EventType}" Width="150"/>
                            <DataGridTextColumn Header="Severity" Binding="{Binding Severity}" Width="80">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Severity}" Value="Critical">
                                                <Setter Property="Foreground" Value="Red"/>
                                                <Setter Property="FontWeight" Value="Bold"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Severity}" Value="Warning">
                                                <Setter Property="Foreground" Value="Orange"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="Root Cause" Binding="{Binding RootCause}" Width="250"/>
                            <DataGridTextColumn Header="Suggested Fix" Binding="{Binding SuggestedFix}" Width="*"/>
                        </DataGrid.Columns>
                    </DataGrid>
                    
                    <!-- Details Panel -->
                    <Expander Grid.Row="1" Header="Event Details" IsExpanded="False" Margin="0,5,0,0">
                        <TextBox Text="{Binding SelectedEvent.RawData, Mode=OneWay}" 
                                 IsReadOnly="True" TextWrapping="Wrap" MaxHeight="150"
                                 VerticalScrollBarVisibility="Auto" FontFamily="Consolas" FontSize="11"/>
                    </Expander>
                </Grid>
            </TabItem>

            <!-- Blue Screens Tab -->
            <TabItem Header="ðŸ’¥ Blue Screens (BSOD)">
                <DataGrid ItemsSource="{Binding BSODEvents}" AutoGenerateColumns="False" 
                          IsReadOnly="True" CanUserAddRows="False" SelectedItem="{Binding SelectedEvent}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Time" Binding="{Binding TimeStamp, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" Width="150"/>
                        <DataGridTextColumn Header="Root Cause" Binding="{Binding RootCause}" Width="300"/>
                        <DataGridTextColumn Header="Suggested Fix" Binding="{Binding SuggestedFix}" Width="*"/>
                        <DataGridTextColumn Header="Event ID" Binding="{Binding EventId}" Width="80"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

            <!-- Application Crashes Tab -->
            <TabItem Header="ðŸ“± Application Crashes">
                <DataGrid ItemsSource="{Binding AppCrashes}" AutoGenerateColumns="False" 
                          IsReadOnly="True" CanUserAddRows="False">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Time" Binding="{Binding TimeStamp, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" Width="150"/>
                        <DataGridTextColumn Header="Type" Binding="{Binding EventType}" Width="150"/>
                        <DataGridTextColumn Header="Application/Module" Binding="{Binding RootCause}" Width="300"/>
                        <DataGridTextColumn Header="Suggested Fix" Binding="{Binding SuggestedFix}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

            <!-- Crash Dumps Tab -->
            <TabItem Header="ðŸ“ Crash Dumps">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <DataGrid Grid.Row="0" ItemsSource="{Binding CrashDumps}" AutoGenerateColumns="False" 
                              IsReadOnly="True" CanUserAddRows="False" SelectedItem="{Binding SelectedDump}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="File Name" Binding="{Binding FileName}" Width="250"/>
                            <DataGridTextColumn Header="Type" Binding="{Binding DumpType}" Width="150"/>
                            <DataGridTextColumn Header="Created" Binding="{Binding CreatedTime, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" Width="150"/>
                            <DataGridTextColumn Header="Size" Binding="{Binding FileSizeFormatted}" Width="100"/>
                            <DataGridTextColumn Header="Path" Binding="{Binding FilePath}" Width="*"/>
                        </DataGrid.Columns>
                    </DataGrid>
                    
                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,10,0,0">
                        <Button Content="ðŸ“‚ Open Folder" Command="{Binding OpenDumpFolderCommand}" 
                                MinWidth="180" Height="30" Margin="0,0,10,0"/>
                        <Button Content="ðŸ—‘ï¸ Delete Selected" Command="{Binding DeleteDumpCommand}" 
                                MinWidth="180" Height="30" Margin="0,0,10,0" Background="#FFF44336" Foreground="White"/>
                        <TextBlock Text="ðŸ’¡ Tip: Use WinDbg to analyze dump files for detailed crash information." 
                                   VerticalAlignment="Center" Foreground="Gray" Margin="20,0,0,0"/>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- Root Cause Summary Tab -->
            <TabItem Header="ðŸ“Š Root Cause Summary">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="2*"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Cause List -->
                    <DataGrid Grid.Column="0" ItemsSource="{Binding RootCauseSummary}" AutoGenerateColumns="False" 
                              IsReadOnly="True" CanUserAddRows="False" Margin="0,0,10,0">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Root Cause" Binding="{Binding Key}" Width="*"/>
                            <DataGridTextColumn Header="Count" Binding="{Binding Value}" Width="60"/>
                        </DataGrid.Columns>
                    </DataGrid>
                    
                    <!-- Recommendations -->
                    <GroupBox Grid.Column="1" Header="Recommendations">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel Margin="10">
                                <TextBlock Text="ðŸ”§ General Troubleshooting Steps:" FontWeight="Bold" Margin="0,0,0,10"/>
                                
                                <TextBlock Text="1. Update Windows and Drivers" FontWeight="SemiBold" Margin="0,5,0,0"/>
                                <TextBlock Text="   â€¢ Run Windows Update to get latest patches" TextWrapping="Wrap" Foreground="Gray"/>
                                <TextBlock Text="   â€¢ Update chipset, graphics, and storage drivers" TextWrapping="Wrap" Foreground="Gray"/>
                                
                                <TextBlock Text="2. Check Hardware Health" FontWeight="SemiBold" Margin="0,10,0,0"/>
                                <TextBlock Text="   â€¢ Run Windows Memory Diagnostic (mdsched.exe)" TextWrapping="Wrap" Foreground="Gray"/>
                                <TextBlock Text="   â€¢ Check disk health with 'chkdsk /f'" TextWrapping="Wrap" Foreground="Gray"/>
                                <TextBlock Text="   â€¢ Monitor temperatures with HWiNFO or similar" TextWrapping="Wrap" Foreground="Gray"/>
                                
                                <TextBlock Text="3. Power Supply" FontWeight="SemiBold" Margin="0,10,0,0"/>
                                <TextBlock Text="   â€¢ Ensure adequate wattage for your system" TextWrapping="Wrap" Foreground="Gray"/>
                                <TextBlock Text="   â€¢ Check all power connections" TextWrapping="Wrap" Foreground="Gray"/>
                                <TextBlock Text="   â€¢ Consider using a UPS for protection" TextWrapping="Wrap" Foreground="Gray"/>
                                
                                <TextBlock Text="4. System Integrity" FontWeight="SemiBold" Margin="0,10,0,0"/>
                                <TextBlock Text="   â€¢ Run 'sfc /scannow' to repair system files" TextWrapping="Wrap" Foreground="Gray"/>
                                <TextBlock Text="   â€¢ Run 'DISM /Online /Cleanup-Image /RestoreHealth'" TextWrapping="Wrap" Foreground="Gray"/>
                                
                                <TextBlock Text="5. Analyze Crash Dumps" FontWeight="SemiBold" Margin="0,10,0,0"/>
                                <TextBlock Text="   â€¢ Install Windows Debugging Tools (WinDbg)" TextWrapping="Wrap" Foreground="Gray"/>
                                <TextBlock Text="   â€¢ Use '!analyze -v' command for detailed analysis" TextWrapping="Wrap" Foreground="Gray"/>
                            </StackPanel>
                        </ScrollViewer>
                    </GroupBox>
                </Grid>
            </TabItem>

            <!-- Clean Shutdowns Tab -->
            <TabItem Header="âœ… Clean Shutdowns">
                <DataGrid ItemsSource="{Binding CleanShutdowns}" AutoGenerateColumns="False" 
                          IsReadOnly="True" CanUserAddRows="False">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Time" Binding="{Binding TimeStamp, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" Width="150"/>
                        <DataGridTextColumn Header="Type" Binding="{Binding EventType}" Width="180"/>
                        <DataGridTextColumn Header="Reason" Binding="{Binding RootCause}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
        </TabControl>

        <!-- Status Bar -->
        <Border Grid.Row="5" Background="{DynamicResource StatusBarBackgroundBrush}" Padding="10,5" Margin="0,10,0,0">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="Last Analysis: " Foreground="Gray"/>
                <TextBlock Text="{Binding LastAnalysisTime, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" FontWeight="SemiBold"/>
                <TextBlock Text="  |  Days Analyzed: " Foreground="Gray" Margin="20,0,0,0"/>
                <TextBlock Text="{Binding DaysAnalyzed}" FontWeight="SemiBold"/>
                <TextBlock Text="  |  Last Boot: " Foreground="Gray" Margin="20,0,0,0"/>
                <TextBlock Text="{Binding LastBootTime, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" FontWeight="SemiBold"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
