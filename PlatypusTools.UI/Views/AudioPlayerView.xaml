<UserControl x:Class="PlatypusTools.UI.Views.AudioPlayerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vm="clr-namespace:PlatypusTools.UI.ViewModels"
             xmlns:local="clr-namespace:PlatypusTools.UI.Views"
             xmlns:converters="clr-namespace:PlatypusTools.UI.Converters"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="1000">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" />
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
    </UserControl.Resources>
    
    <!-- Keyboard Shortcuts -->
    <UserControl.InputBindings>
        <!-- Space: Play/Pause -->
        <KeyBinding Key="Space" Command="{Binding PlayPauseCommand}" />
        <!-- Ctrl+Right: Next track -->
        <KeyBinding Key="Right" Modifiers="Ctrl" Command="{Binding NextCommand}" />
        <!-- Ctrl+Left: Previous track -->
        <KeyBinding Key="Left" Modifiers="Ctrl" Command="{Binding PreviousCommand}" />
        <!-- Up: Volume up -->
        <KeyBinding Key="Up" Command="{Binding VolumeUpCommand}" />
        <!-- Down: Volume down -->
        <KeyBinding Key="Down" Command="{Binding VolumeDownCommand}" />
        <!-- M: Toggle mute -->
        <KeyBinding Key="M" Command="{Binding ToggleMuteCommand}" />
        <!-- S: Toggle shuffle -->
        <KeyBinding Key="S" Command="{Binding ToggleShuffleCommand}" />
        <!-- R: Cycle repeat mode -->
        <KeyBinding Key="R" Command="{Binding CycleRepeatCommand}" />
        <!-- Ctrl+O: Open files -->
        <KeyBinding Key="O" Modifiers="Ctrl" Command="{Binding OpenFileCommand}" />
        <!-- Ctrl+L: Toggle library view -->
        <KeyBinding Key="L" Modifiers="Ctrl" Command="{Binding ToggleLibraryCommand}" />
        <!-- Delete: Remove selected from queue -->
        <KeyBinding Key="Delete" Command="{Binding RemoveSelectedFromQueueCommand}" />
    </UserControl.InputBindings>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Toolbar -->
        <ToolBar Grid.Row="0" Margin="5">
            <Button Content="ðŸ“‚ Open Files" Command="{Binding OpenFileCommand}" Padding="8,4" ToolTip="Open audio files"/>
            <Button Content="ðŸ“ Scan Folder" Command="{Binding OpenFolderCommand}" Padding="8,4" ToolTip="Scan folder for audio"/>
            <Button Content="âž• Add to Queue" Command="{Binding ScanFolderAddToQueueCommand}" Padding="8,4" ToolTip="Scan folder and add to existing queue"/>
            <Separator/>
            <CheckBox Content="Include Subfolders" IsChecked="{Binding IncludeSubfolders}" VerticalAlignment="Center" Margin="5,0"/>
            <Separator/>
            <Button Content="ðŸ“š Library" Command="{Binding ToggleLibraryCommand}" Padding="8,4" ToolTip="Show/Hide Library Panel"/>
            <Separator/>
            <Button Content="ðŸ—‘ï¸ Clear Queue" Command="{Binding ClearQueueCommand}" Padding="8,4" ToolTip="Clear all tracks from queue"/>
        </ToolBar>
        
        <!-- Main Content -->
        <Grid Grid.Row="1" Margin="5">
            <Grid.RowDefinitions>
                <RowDefinition Height="250"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <!-- Top Panel: Visualizer + Controls (Separate Pane) -->
            <Border Grid.Row="0" Background="#1a1a2e" CornerRadius="8" Margin="0,0,0,5">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Audio Visualizer (Always Visible) -->
                    <local:AudioVisualizerView x:Name="VisualizerControl" Grid.Row="0"/>
                    
                    <!-- Visualizer Controls -->
                    <Border Grid.Row="1" Background="#2a2a3e" Padding="8">
                        <StackPanel Orientation="Horizontal" Margin="0">
                            <TextBlock Text="Mode:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="White"/>
                        <ComboBox Width="120" SelectedIndex="{Binding VisualizerModeIndex}" VerticalAlignment="Center">
                            <ComboBoxItem Content="Bars"/>
                            <ComboBoxItem Content="Mirror"/>
                            <ComboBoxItem Content="Waveform"/>
                            <ComboBoxItem Content="Circular"/>
                        </ComboBox>
                        <Separator Margin="15,0" Background="#444"/>
                        <TextBlock Text="Bars:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="White"/>
                        <Slider Value="{Binding BarCount}" Minimum="8" Maximum="128" Width="100" VerticalAlignment="Center" 
                               IsSnapToTickEnabled="True" TickFrequency="8"/>
                        <TextBlock Text="{Binding BarCount}" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="White" Width="30"/>
                        <Separator Margin="15,0" Background="#444"/>
                        <TextBlock Text="EQ:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="White"/>
                        <ComboBox Width="120" ItemsSource="{Binding EQPresets}" 
                                  SelectedItem="{Binding SelectedPreset}"
                                  DisplayMemberPath="Name" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>
            
            <!-- Player Controls - NOW IN GRID.ROW="3" AT BOTTOM -->
            
            <!-- Bottom Panel: Queue or Library -->
            <Border Grid.Row="2" Background="White" CornerRadius="0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="300"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Main Content Area -->
                    <TabControl Grid.Column="0" Margin="5">
                    <TabItem Header="Queue" IsSelected="{Binding IsPlayerView}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Queue Controls -->
                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="5">
                                <Button Content="ðŸ—‘ Remove Selected" Padding="8,4" Margin="0,0,5,0"
                                        x:Name="RemoveSelectedBtn" Click="OnRemoveSelectedClick"
                                        ToolTip="Remove selected tracks from queue (multi-select with Ctrl+Click)"/>
                                <Button Content="ðŸ”„ Clear Queue" Padding="8,4"
                                        x:Name="ClearQueueBtn" Click="OnClearQueueClick"
                                        ToolTip="Remove all tracks from queue"/>
                                <TextBlock Text="{Binding Queue.Count, StringFormat='({0} tracks)'}" 
                                           VerticalAlignment="Center" Margin="10,0,0,0" Foreground="Gray"/>
                            </StackPanel>
                            
                            <ListBox Grid.Row="1" x:Name="QueueListBox"
                                     ItemsSource="{Binding Queue}" 
                                     SelectedItem="{Binding SelectedQueueTrack}"
                                     SelectionMode="Extended"
                                     Background="Transparent" BorderThickness="0">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="2">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="{Binding DisplayTitle}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                                            <TextBlock Text="{Binding DisplayArtist}" FontSize="11" Foreground="Gray" TextTrimming="CharacterEllipsis"/>
                                        </StackPanel>
                                        
                                        <TextBlock Grid.Column="1" Text="{Binding DurationFormatted}" 
                                                   VerticalAlignment="Center" Margin="10,0" Foreground="Gray" FontSize="11"/>
                                        
                                        <Button Grid.Column="2" Content="â–¶" Width="24" Height="24" 
                                                Command="{Binding DataContext.PlayTrackCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                CommandParameter="{Binding}"
                                                ToolTip="Play this track"/>
                                        
                                        <Button Grid.Column="3" Content="âœ•" Width="24" Height="24" Margin="4,0,0,0"
                                                Command="{Binding DataContext.RemoveFromQueueCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                CommandParameter="{Binding}"
                                                ToolTip="Remove from queue"/>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                        </Grid>
                    </TabItem>
                    <TabItem Header="Library">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Library Scanning Section -->
                            <GroupBox Grid.Row="0" Header="ðŸ“š Library Management" Margin="0,0,0,8">
                                <Grid Margin="8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    
                                    <!-- Scan Buttons -->
                                    <Button Grid.Column="0" Grid.Row="0" Content="ðŸ” Scan Library" 
                                            Width="140" Command="{Binding ScanLibraryCommand}" 
                                            FontWeight="Bold" Margin="0,0,8,0"/>
                                    
                                    <!-- Statistics -->
                                    <StackPanel Grid.Column="1" Grid.Row="0" Orientation="Horizontal" VerticalAlignment="Center">
                                        <TextBlock Text="Tracks:" FontWeight="Bold" Margin="0,0,4,0"/>
                                        <TextBlock Text="{Binding LibraryTrackCount, FallbackValue=0}" Margin="0,0,15,0"/>
                                        <TextBlock Text="Artists:" FontWeight="Bold" Margin="0,0,4,0"/>
                                        <TextBlock Text="{Binding LibraryArtistCount, FallbackValue=0}" Margin="0,0,15,0"/>
                                        <TextBlock Text="Albums:" FontWeight="Bold" Margin="0,0,4,0"/>
                                        <TextBlock Text="{Binding LibraryAlbumCount, FallbackValue=0}"/>
                                    </StackPanel>
                                    
                                    <!-- Scan Status -->
                                    <TextBlock Grid.Column="2" Grid.Row="0" Text="{Binding ScanStatus}" 
                                               Foreground="#FF6600" FontWeight="Bold" VerticalAlignment="Center"
                                               Margin="15,0,8,0"/>
                                    
                                    <!-- Cancel Button -->
                                    <Button Grid.Column="3" Grid.Row="0" Content="Cancel" 
                                            Width="80" Command="{Binding CancelScanCommand}"
                                            Visibility="{Binding IsScanning, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                    
                                    <!-- Progress Bar -->
                                    <ProgressBar Grid.Column="0" Grid.ColumnSpan="4" Grid.Row="1" 
                                                 Value="{Binding ScanProgress}" IsIndeterminate="{Binding IsScanning}"
                                                 Height="20" Margin="0,8,0,0"/>
                                </Grid>
                            </GroupBox>
                            
                            <!-- Library Toolbar -->
                            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,8">
                                <TextBlock Text="Organize by:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <ComboBox Width="120" SelectedIndex="{Binding OrganizeModeIndex}">
                                    <ComboBoxItem Content="All Tracks"/>
                                    <ComboBoxItem Content="Artist"/>
                                    <ComboBoxItem Content="Album"/>
                                    <ComboBoxItem Content="Genre"/>
                                    <ComboBoxItem Content="Folder"/>
                                </ComboBox>
                                <Separator Margin="15,0"/>
                                <TextBox Width="200" Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}" 
                                         VerticalAlignment="Center">
                                    <TextBox.Style>
                                        <Style TargetType="TextBox">
                                            <Style.Triggers>
                                                <Trigger Property="Text" Value="">
                                                    <Setter Property="Background">
                                                        <Setter.Value>
                                                            <VisualBrush Stretch="None" AlignmentX="Left">
                                                                <VisualBrush.Visual>
                                                                    <TextBlock Text="ðŸ” Search library..." Foreground="Gray" Margin="5,0"/>
                                                                </VisualBrush.Visual>
                                                            </VisualBrush>
                                                        </Setter.Value>
                                                    </Setter>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBox.Style>
                                </TextBox>
                                <Separator Margin="15,0"/>
                                <TextBlock Text="{Binding LibraryTrackCount, StringFormat={}{0} tracks}" VerticalAlignment="Center" Foreground="Gray"/>
                            </StackPanel>
                            
                            <!-- Groups List (Artists/Albums/Genres) -->
                            <ListBox Grid.Row="2" Height="80" ItemsSource="{Binding LibraryGroups}" 
                                     SelectedItem="{Binding SelectedGroup}"
                                     Visibility="{Binding ShowGroups, Converter={StaticResource BoolToVisibilityConverter}}"
                                     Margin="0,0,0,8">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" Margin="5,3">
                                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold" Width="200"/>
                                            <TextBlock Text="{Binding TrackCount, StringFormat=({0})}" Foreground="Gray"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                            
                            <!-- Library Track List -->
                            <DataGrid x:Name="LibraryTrackGrid" Grid.Row="3" ItemsSource="{Binding LibraryTracks}" 
                                      SelectedItem="{Binding SelectedLibraryTrack}"
                                      AutoGenerateColumns="False" IsReadOnly="True"
                                      CanUserResizeColumns="True" CanUserSortColumns="True"
                                      ColumnHeaderHeight="32"
                                      GridLinesVisibility="Horizontal" AlternatingRowBackground="#f8f8f8"
                                      HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                                <DataGrid.ColumnHeaderStyle>
                                    <Style TargetType="DataGridColumnHeader">
                                        <Setter Property="HorizontalContentAlignment" Value="Left"/>
                                        <Setter Property="Padding" Value="8,4"/>
                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                    </Style>
                                </DataGrid.ColumnHeaderStyle>
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Title" Binding="{Binding DisplayTitle}" Width="*" MinWidth="150" CanUserResize="True"/>
                                    <DataGridTextColumn Header="Artist" Binding="{Binding DisplayArtist}" Width="150" MinWidth="80" CanUserResize="True"/>
                                    <DataGridTextColumn Header="Album" Binding="{Binding DisplayAlbum}" Width="150" MinWidth="80" CanUserResize="True"/>
                                    <DataGridTextColumn Header="Duration" Binding="{Binding DurationFormatted}" Width="60" MinWidth="50" CanUserResize="True"/>
                                    <DataGridTextColumn Header="Genre" Binding="{Binding Genre}" Width="80" MinWidth="60" CanUserResize="True"/>
                                </DataGrid.Columns>
                                <DataGrid.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="Play" Command="{Binding PlaySelectedCommand}"/>
                                        <MenuItem Header="Add to Queue" Command="{Binding AddToQueueCommand}"/>
                                        <Separator/>
                                        <MenuItem Header="Add All to Queue" Command="{Binding AddAllToQueueCommand}"/>
                                    </ContextMenu>
                                </DataGrid.ContextMenu>
                            </DataGrid>
                        </Grid>
                    </TabItem>
                </TabControl>
                
                <!-- Track Info Panel -->
                <GroupBox Grid.Column="2" Header="Now Playing" Margin="5,0,0,0">
                    <StackPanel Margin="8">
                        <Border Width="100" Height="100" Background="#2d2d44" CornerRadius="8" Margin="0,0,0,12" HorizontalAlignment="Center">
                            <TextBlock Text="ðŸŽµ" FontSize="50" HorizontalAlignment="Center" VerticalAlignment="Center" 
                                       Foreground="#4a4a6a"/>
                        </Border>
                        <TextBlock Text="{Binding CurrentTrack.DisplayTitle, FallbackValue='No track'}" 
                                   FontSize="14" FontWeight="Bold" TextWrapping="Wrap" Margin="0,0,0,4"/>
                        <TextBlock Text="{Binding CurrentTrack.DisplayArtist, FallbackValue='Unknown'}" 
                                   FontSize="12" Foreground="Gray" TextWrapping="Wrap" Margin="0,0,0,2"/>
                        <TextBlock Text="{Binding CurrentTrack.DisplayAlbum, FallbackValue='Unknown'}" 
                                   FontSize="11" Foreground="#999" TextWrapping="Wrap" Margin="0,0,0,12"/>
                        
                        <ProgressBar Value="{Binding PositionSeconds}" Maximum="{Binding DurationSeconds}" 
                                     Height="8" Margin="0,0,0,4"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="{Binding PositionDisplay}" FontSize="11" Foreground="Gray"/>
                            <TextBlock Grid.Column="1" Text="{Binding DurationDisplay}" FontSize="11" Foreground="Gray"/>
                        </Grid>
                        
                        <Separator Margin="0,12" Background="#ddd"/>
                        
                        <Button Content="ðŸ“‚ Open Files" Command="{Binding OpenFileCommand}" Width="120" HorizontalAlignment="Left" Margin="0,0,0,4"/>
                        <Button Content="ðŸ“ Scan Folder" Command="{Binding OpenFolderCommand}" Width="120" HorizontalAlignment="Left" Margin="0,0,0,4"/>
                        <Button Content="ðŸ—‘ï¸ Clear Queue" Command="{Binding ClearQueueCommand}" Width="120" HorizontalAlignment="Left"/>
                    </StackPanel>
                </GroupBox>
                </Grid>
            </Border>
        </Grid>
        
                <!-- Playback Controls -->
        <Border Grid.Row="3" Background="#f5f5f5" Padding="15,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Left: Shuffle/Repeat -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="{Binding RepeatIcon}" Width="36" Height="36" 
                            Command="{Binding CycleRepeatCommand}" 
                            ToolTip="Cycle repeat mode"
                            FontSize="16" Margin="0,0,5,0"
                            Background="Transparent" BorderThickness="0"/>
                    <ToggleButton Content="ðŸ”€" Width="36" Height="36" 
                                  IsChecked="{Binding IsShuffle}"
                                  ToolTip="Toggle shuffle"
                                  FontSize="16"
                                  Background="Transparent" BorderThickness="0"/>
                </StackPanel>
                
                <!-- Center: Transport Controls -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center">
                    <Button Content="â®" Width="44" Height="44" Command="{Binding PreviousCommand}" 
                            FontSize="18" Background="Transparent" BorderThickness="0"
                            ToolTip="Previous"/>
                    <Button Content="{Binding PlayPauseIcon}" Width="36" Height="36" 
                            Command="{Binding PlayPauseCommand}" 
                            FontSize="18" Margin="15,0"
                            Background="Transparent" BorderThickness="0"
                            ToolTip="Play/Pause"/>
                    <Button Content="â­" Width="44" Height="44" Command="{Binding NextCommand}" 
                            FontSize="18" Background="Transparent" BorderThickness="0"
                            ToolTip="Next"/>
                    <Button Content="â¹" Width="36" Height="36" Command="{Binding StopCommand}" 
                            FontSize="14" Background="Transparent" BorderThickness="0" Margin="15,0,0,0"
                            ToolTip="Stop"/>
                </StackPanel>
                
                <!-- Right: Volume -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="ðŸ”Š" 
                            Width="30" Height="30"
                            Command="{Binding ToggleMuteCommand}"
                            FontSize="14" Background="Transparent" BorderThickness="0"
                            ToolTip="Toggle mute"/>
                    <Slider Width="100" Minimum="0" Maximum="1" Value="{Binding Volume}" 
                            VerticalAlignment="Center" Margin="5,0"/>
                    <TextBlock Text="{Binding VolumePercent, StringFormat={}{0}%}" 
                               Width="35" VerticalAlignment="Center" Foreground="Gray" FontSize="11"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
