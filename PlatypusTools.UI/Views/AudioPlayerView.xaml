<UserControl x:Class="PlatypusTools.UI.Views.AudioPlayerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vm="clr-namespace:PlatypusTools.UI.ViewModels"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="1000">
    <UserControl.DataContext>
        <vm:AudioPlayerViewModel />
    </UserControl.DataContext>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Toolbar -->
        <ToolBar Grid.Row="0" Margin="5">
            <Button Content="ðŸ“‚ Open Files" Command="{Binding OpenFileCommand}" Padding="8,4" ToolTip="Open audio files"/>
            <Button Content="ðŸ“ Scan Folder" Command="{Binding OpenFolderCommand}" Padding="8,4" ToolTip="Scan folder for audio"/>
            <Separator/>
            <CheckBox Content="Include Subfolders" IsChecked="{Binding IncludeSubfolders}" VerticalAlignment="Center" Margin="5,0"/>
            <Separator/>
            <Button Content="ðŸ“š Library" Command="{Binding ToggleLibraryCommand}" Padding="8,4" ToolTip="Show/Hide Library Panel"/>
            <Separator/>
            <TextBlock Text="View:" VerticalAlignment="Center" Margin="5,0"/>
            <ComboBox Width="100" SelectedIndex="{Binding ViewModeIndex}" VerticalAlignment="Center">
                <ComboBoxItem Content="Player"/>
                <ComboBoxItem Content="Library"/>
            </ComboBox>
            <Separator/>
            <Button Content="ðŸ—‘ï¸ Clear Queue" Command="{Binding ClearQueueCommand}" Padding="8,4"/>
        </ToolBar>
        
        <!-- Main Content -->
        <Grid Grid.Row="1" Margin="5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="320"/>
            </Grid.ColumnDefinitions>
            
            <!-- Player Panel -->
            <Grid Grid.Column="0" Margin="0,0,5,0" Visibility="{Binding IsPlayerView, Converter={StaticResource BoolToVisibilityConverter}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Album Art / Visualizer Area -->
                <Border Grid.Row="0" Background="#1a1a2e" CornerRadius="8">
                    <Grid>
                        <!-- Album Art -->
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center"
                                    Visibility="{Binding CurrentTrack, Converter={StaticResource NullToVisibilityConverter}}">
                            <Border Width="180" Height="180" Background="#2d2d44" CornerRadius="8" Margin="0,0,0,15">
                                <TextBlock Text="ðŸŽµ" FontSize="70" HorizontalAlignment="Center" VerticalAlignment="Center" 
                                           Foreground="#4a4a6a"/>
                            </Border>
                            <TextBlock Text="{Binding CurrentTrack.DisplayTitle}" 
                                       FontSize="22" FontWeight="Bold" Foreground="White" 
                                       HorizontalAlignment="Center" TextTrimming="CharacterEllipsis" MaxWidth="320"/>
                            <TextBlock Text="{Binding CurrentTrack.DisplayArtist}" 
                                       FontSize="15" Foreground="#aaa" 
                                       HorizontalAlignment="Center" Margin="0,4,0,0"/>
                            <TextBlock Text="{Binding CurrentTrack.DisplayAlbum}" 
                                       FontSize="13" Foreground="#666" 
                                       HorizontalAlignment="Center" Margin="0,4,0,0"/>
                        </StackPanel>
                        
                        <!-- Placeholder when no track -->
                        <StackPanel x:Name="NoTrackPlaceholder" HorizontalAlignment="Center" VerticalAlignment="Center">
                            <TextBlock Text="ðŸŽ§" FontSize="80" Foreground="#4a4a6a" HorizontalAlignment="Center"/>
                            <TextBlock Text="No Track Loaded" FontSize="16" Foreground="#666" HorizontalAlignment="Center" Margin="0,15,0,0"/>
                            <TextBlock Text="Open files or scan a folder to start playing" FontSize="11" Foreground="#555" HorizontalAlignment="Center"/>
                        </StackPanel>
                        
                        <!-- Spectrum Visualizer -->
                        <Canvas x:Name="VisualizerCanvas" Height="80" VerticalAlignment="Bottom" Margin="15,0,15,15"
                                Visibility="{Binding IsPlaying, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    </Grid>
                </Border>
                
                <!-- Visualizer Mode Selector -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,8,0,0">
                    <TextBlock Text="Visualizer:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <ComboBox Width="120" SelectedIndex="{Binding VisualizerModeIndex}">
                        <ComboBoxItem Content="Bars"/>
                        <ComboBoxItem Content="Mirror Bars"/>
                        <ComboBoxItem Content="Waveform"/>
                        <ComboBoxItem Content="Circular"/>
                        <ComboBoxItem Content="None"/>
                    </ComboBox>
                    <Separator Margin="15,0"/>
                    <TextBlock Text="EQ:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <ComboBox Width="120" ItemsSource="{Binding EQPresets}" 
                              SelectedItem="{Binding SelectedPreset}"
                              DisplayMemberPath="Name"/>
                </StackPanel>
                
                <!-- Scan Status -->
                <Border Grid.Row="2" Margin="0,8,0,0" Padding="8" Background="#e3f2fd" CornerRadius="4"
                        Visibility="{Binding IsScanning, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel>
                        <TextBlock Text="{Binding ScanStatus}" FontSize="12"/>
                        <ProgressBar Height="4" IsIndeterminate="True" Margin="0,5,0,0"/>
                    </StackPanel>
                </Border>
            </Grid>
            
            <!-- Library Panel (when in Library view) -->
            <Grid Grid.Column="0" Margin="0,0,5,0" Visibility="{Binding IsLibraryView, Converter={StaticResource BoolToVisibilityConverter}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <!-- Library Toolbar -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
                    <TextBlock Text="Organize by:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <ComboBox Width="100" SelectedIndex="{Binding OrganizeModeIndex}">
                        <ComboBoxItem Content="All Tracks"/>
                        <ComboBoxItem Content="Artist"/>
                        <ComboBoxItem Content="Album"/>
                        <ComboBoxItem Content="Genre"/>
                        <ComboBoxItem Content="Folder"/>
                    </ComboBox>
                    <Separator Margin="15,0"/>
                    <TextBox Width="200" Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}" 
                             VerticalAlignment="Center">
                        <TextBox.Style>
                            <Style TargetType="TextBox">
                                <Style.Triggers>
                                    <Trigger Property="Text" Value="">
                                        <Setter Property="Background">
                                            <Setter.Value>
                                                <VisualBrush Stretch="None" AlignmentX="Left">
                                                    <VisualBrush.Visual>
                                                        <TextBlock Text="ðŸ” Search library..." Foreground="Gray" Margin="5,0"/>
                                                    </VisualBrush.Visual>
                                                </VisualBrush>
                                            </Setter.Value>
                                        </Setter>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </TextBox.Style>
                    </TextBox>
                    <Separator Margin="15,0"/>
                    <TextBlock Text="{Binding LibraryTrackCount, StringFormat={}{0} tracks}" VerticalAlignment="Center" Foreground="Gray"/>
                </StackPanel>
                
                <!-- Groups List (Artists/Albums/Genres) -->
                <ListBox Grid.Row="1" Height="120" ItemsSource="{Binding LibraryGroups}" 
                         SelectedItem="{Binding SelectedGroup}"
                         Visibility="{Binding ShowGroups, Converter={StaticResource BoolToVisibilityConverter}}"
                         Margin="0,0,0,8">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" Margin="5,3">
                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold" Width="200"/>
                                <TextBlock Text="{Binding TrackCount, StringFormat=({0})}" Foreground="Gray"/>
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                
                <!-- Library Track List -->
                <DataGrid Grid.Row="2" ItemsSource="{Binding LibraryTracks}" 
                          SelectedItem="{Binding SelectedLibraryTrack}"
                          AutoGenerateColumns="False" IsReadOnly="True"
                          CanUserResizeColumns="True" CanUserSortColumns="True"
                          GridLinesVisibility="Horizontal" AlternatingRowBackground="#f8f8f8">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Title" Binding="{Binding DisplayTitle}" Width="*" MinWidth="150"/>
                        <DataGridTextColumn Header="Artist" Binding="{Binding DisplayArtist}" Width="150"/>
                        <DataGridTextColumn Header="Album" Binding="{Binding DisplayAlbum}" Width="150"/>
                        <DataGridTextColumn Header="Duration" Binding="{Binding DurationFormatted}" Width="60"/>
                        <DataGridTextColumn Header="Genre" Binding="{Binding Genre}" Width="80"/>
                    </DataGrid.Columns>
                    <DataGrid.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Play" Command="{Binding PlaySelectedCommand}"/>
                            <MenuItem Header="Add to Queue" Command="{Binding AddToQueueCommand}"/>
                            <Separator/>
                            <MenuItem Header="Add All to Queue" Command="{Binding AddAllToQueueCommand}"/>
                        </ContextMenu>
                    </DataGrid.ContextMenu>
                </DataGrid>
            </Grid>
            
            <!-- Queue Panel -->
            <GroupBox Grid.Column="2" Margin="5,0,0,0">
                <GroupBox.Header>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="Queue" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding Queue.Count, StringFormat= ({0})}" Foreground="Gray"/>
                    </StackPanel>
                </GroupBox.Header>
                <Grid>
                    <ListBox ItemsSource="{Binding Queue}" 
                             SelectedItem="{Binding CurrentTrack}"
                             Background="Transparent" BorderThickness="0">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="{Binding DisplayTitle}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                                        <TextBlock Text="{Binding DisplayArtist}" FontSize="11" Foreground="Gray" TextTrimming="CharacterEllipsis"/>
                                    </StackPanel>
                                    
                                    <TextBlock Grid.Column="1" Text="{Binding DurationFormatted}" 
                                               VerticalAlignment="Center" Margin="10,0" Foreground="Gray" FontSize="11"/>
                                    
                                    <Button Grid.Column="2" Content="â–¶" Width="24" Height="24" 
                                            Command="{Binding DataContext.PlayTrackCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                            CommandParameter="{Binding}"
                                            ToolTip="Play this track"/>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    
                    <!-- Empty queue message -->
                    <TextBlock x:Name="EmptyQueueMessage"
                               Text="Queue is empty&#x0a;Open files to add tracks"
                               HorizontalAlignment="Center" VerticalAlignment="Center"
                               TextAlignment="Center" Foreground="Gray"/>
                </Grid>
            </GroupBox>
        </Grid>
        
        <!-- Seek Bar -->
        <Grid Grid.Row="2" Margin="10,5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="50"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="50"/>
            </Grid.ColumnDefinitions>
            
            <TextBlock Grid.Column="0" Text="{Binding PositionDisplay}" VerticalAlignment="Center" Foreground="Gray"/>
            <Slider Grid.Column="1" Minimum="0" Maximum="{Binding DurationSeconds}" 
                    Value="{Binding PositionSeconds, Mode=TwoWay}" 
                    Margin="10,0"/>
            <TextBlock Grid.Column="2" Text="{Binding DurationDisplay}" VerticalAlignment="Center" Foreground="Gray" HorizontalAlignment="Right"/>
        </Grid>
        
        <!-- Playback Controls -->
        <Border Grid.Row="3" Background="#f5f5f5" Padding="15,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Left: Shuffle/Repeat -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="{Binding RepeatIcon}" Width="36" Height="36" 
                            Command="{Binding CycleRepeatCommand}" 
                            ToolTip="Cycle repeat mode"
                            FontSize="16" Margin="0,0,5,0"
                            Background="Transparent" BorderThickness="0"/>
                    <ToggleButton Content="ðŸ”€" Width="36" Height="36" 
                                  IsChecked="{Binding IsShuffle}"
                                  ToolTip="Toggle shuffle"
                                  FontSize="16"
                                  Background="Transparent" BorderThickness="0"/>
                </StackPanel>
                
                <!-- Center: Transport Controls -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center">
                    <Button Content="â®" Width="44" Height="44" Command="{Binding PreviousCommand}" 
                            FontSize="18" Background="Transparent" BorderThickness="0"
                            ToolTip="Previous"/>
                    <Button Content="{Binding PlayPauseIcon}" Width="56" Height="56" 
                            Command="{Binding PlayPauseCommand}" 
                            FontSize="24" FontWeight="Bold" Margin="15,0"
                            Background="#2196F3" Foreground="White"
                            ToolTip="Play/Pause">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border Background="{TemplateBinding Background}" CornerRadius="28" 
                                        BorderBrush="#1976D2" BorderThickness="2">
                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </Button.Template>
                    </Button>
                    <Button Content="â­" Width="44" Height="44" Command="{Binding NextCommand}" 
                            FontSize="18" Background="Transparent" BorderThickness="0"
                            ToolTip="Next"/>
                    <Button Content="â¹" Width="36" Height="36" Command="{Binding StopCommand}" 
                            FontSize="14" Background="Transparent" BorderThickness="0" Margin="15,0,0,0"
                            ToolTip="Stop"/>
                </StackPanel>
                
                <!-- Right: Volume -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="ðŸ”Š" 
                            Width="30" Height="30"
                            Command="{Binding ToggleMuteCommand}"
                            FontSize="14" Background="Transparent" BorderThickness="0"
                            ToolTip="Toggle mute"/>
                    <Slider Width="100" Minimum="0" Maximum="1" Value="{Binding Volume}" 
                            VerticalAlignment="Center" Margin="5,0"/>
                    <TextBlock Text="{Binding VolumePercent, StringFormat={}{0}%}" 
                               Width="35" VerticalAlignment="Center" Foreground="Gray" FontSize="11"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
