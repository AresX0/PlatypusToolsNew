<UserControl x:Class="PlatypusTools.UI.Views.ForensicsAnalyzerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:PlatypusTools.UI.ViewModels">
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="5"/>
            <RowDefinition Height="*" MinHeight="100"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,15">
            <TextBlock Text="ðŸ”¬ Forensics Analyzer" FontSize="24" FontWeight="Bold" Margin="0,0,0,5"/>
            <TextBlock Text="Analyze system memory, file system, registry, and event logs for security issues and anomalies." 
                       Foreground="{DynamicResource SecondaryTextBrush}" TextWrapping="Wrap"/>
        </StackPanel>

        <!-- Analysis Controls -->
        <GroupBox Header="Analysis Mode" Grid.Row="1" Margin="0,0,0,10">
            <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Lightweight Mode -->
                <Border Grid.Column="0" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" 
                        CornerRadius="5" Padding="15" Margin="0,0,5,0" Background="{DynamicResource CardBackgroundBrush}">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="âš¡" FontSize="24" Margin="0,0,10,0"/>
                            <StackPanel>
                                <TextBlock Text="Lightweight Scan" FontSize="16" FontWeight="SemiBold"/>
                                <TextBlock Text="Quick analysis, single core" Foreground="{DynamicResource SecondaryTextBrush}" FontSize="11"/>
                            </StackPanel>
                        </StackPanel>
                        <TextBlock Text="â€¢ Single CPU core" Margin="0,2"/>
                        <TextBlock Text="â€¢ ~1-5 minutes" Margin="0,2"/>
                        <TextBlock Text="â€¢ ~100MB output" Margin="0,2"/>
                        <TextBlock Text="â€¢ Last 24 hours of logs" Margin="0,2"/>
                        <TextBlock Text="â€¢ Critical locations only" Margin="0,2"/>
                        <Button Content="ðŸš€ Run Quick Scan" Command="{Binding RunLightweightAnalysisCommand}" 
                                Height="35" Margin="0,15,0,0" Background="#4CAF50" Foreground="White" FontWeight="Bold"/>
                    </StackPanel>
                </Border>

                <!-- Deep Mode -->
                <Border Grid.Column="1" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" 
                        CornerRadius="5" Padding="15" Margin="5,0,5,0" Background="{DynamicResource CardBackgroundBrush}">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="ðŸ”" FontSize="24" Margin="0,0,10,0"/>
                            <StackPanel>
                                <TextBlock Text="Deep Analysis" FontSize="16" FontWeight="SemiBold"/>
                                <TextBlock Text="Comprehensive, multi-core" Foreground="{DynamicResource SecondaryTextBrush}" FontSize="11"/>
                            </StackPanel>
                        </StackPanel>
                        <TextBlock Text="â€¢ All CPU cores" Margin="0,2"/>
                        <TextBlock Text="â€¢ ~10-30 minutes" Margin="0,2"/>
                        <TextBlock Text="â€¢ Several GB output" Margin="0,2"/>
                        <TextBlock Text="â€¢ Last 7 days of logs" Margin="0,2"/>
                        <TextBlock Text="â€¢ Full system scan + hashes" Margin="0,2"/>
                        <Button Content="ðŸ”¬ Run Deep Analysis" Command="{Binding RunDeepAnalysisCommand}" 
                                Height="35" Margin="0,15,0,0" Background="#2196F3" Foreground="White" FontWeight="Bold"/>
                    </StackPanel>
                </Border>

                <!-- Cancel Button -->
                <StackPanel Grid.Column="2" VerticalAlignment="Center" Width="120">
                    <Button Content="âŒ Cancel" Command="{Binding CancelAnalysisCommand}" 
                            Height="35" Background="#f44336" Foreground="White" Margin="5,0,0,0"
                            Visibility="{Binding IsAnalyzing, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    <Button Content="ðŸ—‘ï¸ Clear" Command="{Binding ClearResultsCommand}" 
                            Height="35" Margin="5,5,0,0"/>
                </StackPanel>
            </Grid>
            </ScrollViewer>
        </GroupBox>

        <!-- Summary Statistics -->
        <GroupBox Header="Summary" Grid.Row="2" Margin="0,0,0,10">
            <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Findings Summary -->
                <StackPanel Grid.Column="0" Grid.Row="0" Margin="5">
                    <TextBlock Text="Findings" FontWeight="Bold" Foreground="{DynamicResource SecondaryTextBrush}"/>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="ðŸ”´" FontSize="12" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding CriticalFindings}" FontSize="18" FontWeight="Bold" Foreground="Red" Margin="3,0,10,0"/>
                        <TextBlock Text="ðŸŸ " FontSize="12" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding HighFindings}" FontSize="18" FontWeight="Bold" Foreground="Orange" Margin="3,0,10,0"/>
                        <TextBlock Text="ðŸŸ¡" FontSize="12" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding MediumFindings}" FontSize="18" FontWeight="Bold" Foreground="Gold" Margin="3,0,10,0"/>
                        <TextBlock Text="ðŸŸ¢" FontSize="12" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding LowFindings}" FontSize="18" FontWeight="Bold" Foreground="Green" Margin="3,0,0,0"/>
                    </StackPanel>
                </StackPanel>

                <!-- Memory -->
                <StackPanel Grid.Column="1" Grid.Row="0" Margin="5">
                    <TextBlock Text="Memory" FontWeight="Bold" Foreground="{DynamicResource SecondaryTextBrush}"/>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="Usage:" Margin="0,0,5,0"/>
                        <TextBlock Text="{Binding MemoryUsage}" FontWeight="Bold"/>
                        <TextBlock Text=" | Suspicious:" Margin="5,0,5,0"/>
                        <TextBlock Text="{Binding SuspiciousProcesses}" FontWeight="Bold" Foreground="Red"/>
                    </StackPanel>
                </StackPanel>

                <!-- File System -->
                <StackPanel Grid.Column="2" Grid.Row="0" Margin="5">
                    <TextBlock Text="File System" FontWeight="Bold" Foreground="{DynamicResource SecondaryTextBrush}"/>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="Scanned:" Margin="0,0,5,0"/>
                        <TextBlock Text="{Binding FilesScanned}" FontWeight="Bold"/>
                        <TextBlock Text=" | Suspicious:" Margin="5,0,5,0"/>
                        <TextBlock Text="{Binding SuspiciousFiles}" FontWeight="Bold" Foreground="Red"/>
                    </StackPanel>
                </StackPanel>

                <!-- Registry -->
                <StackPanel Grid.Column="3" Grid.Row="0" Margin="5">
                    <TextBlock Text="Registry" FontWeight="Bold" Foreground="{DynamicResource SecondaryTextBrush}"/>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="Startup:" Margin="0,0,5,0"/>
                        <TextBlock Text="{Binding StartupEntries}" FontWeight="Bold"/>
                        <TextBlock Text=" | Suspicious:" Margin="5,0,5,0"/>
                        <TextBlock Text="{Binding SuspiciousRegistry}" FontWeight="Bold" Foreground="Red"/>
                    </StackPanel>
                </StackPanel>

                <!-- Event Logs -->
                <StackPanel Grid.Column="0" Grid.Row="1" Margin="5">
                    <TextBlock Text="Event Logs" FontWeight="Bold" Foreground="{DynamicResource SecondaryTextBrush}"/>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="Scanned:" Margin="0,0,5,0"/>
                        <TextBlock Text="{Binding EventsScanned}" FontWeight="Bold"/>
                        <TextBlock Text=" | Suspicious:" Margin="5,0,5,0"/>
                        <TextBlock Text="{Binding SuspiciousEvents}" FontWeight="Bold" Foreground="Red"/>
                    </StackPanel>
                </StackPanel>

                <!-- Duration -->
                <StackPanel Grid.Column="1" Grid.Row="1" Margin="5">
                    <TextBlock Text="Duration" FontWeight="Bold" Foreground="{DynamicResource SecondaryTextBrush}"/>
                    <TextBlock>
                        <Run Text="{Binding AnalysisDuration.TotalMinutes, StringFormat={}{0:F1}, Mode=OneWay}"/>
                        <Run Text=" minutes"/>
                    </TextBlock>
                </StackPanel>

                <!-- Report -->
                <StackPanel Grid.Column="2" Grid.Row="1" Grid.ColumnSpan="2" Margin="5">
                    <TextBlock Text="Report" FontWeight="Bold" Foreground="{DynamicResource SecondaryTextBrush}"/>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding LastReportSize}" FontWeight="Bold" Margin="0,0,10,0"/>
                        <Button Content="ðŸ“‚ Open Folder" Command="{Binding OpenReportFolderCommand}" 
                                IsEnabled="{Binding HasReport}" Padding="5,2" FontSize="11" Margin="0,0,5,0"/>
                        <Button Content="ðŸ“„ Open Report" Command="{Binding OpenReportCommand}" 
                                IsEnabled="{Binding HasReport}" Padding="5,2" FontSize="11" Margin="0,0,5,0"/>
                        <Button Content="ðŸ“‹ Export CSV" Command="{Binding ExportFindingsCommand}" 
                                IsEnabled="{Binding HasFindings}" Padding="5,2" FontSize="11" Margin="0,0,5,0"/>
                        <Button Content="ðŸŒ Export HTML" Command="{Binding ExportHtmlReportCommand}" 
                                IsEnabled="{Binding HasFindings}" Padding="5,2" FontSize="11" ToolTip="Export comprehensive HTML report"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
            </ScrollViewer>
        </GroupBox>

        <!-- GridSplitter -->
        <GridSplitter Grid.Row="3" Height="5" HorizontalAlignment="Stretch" 
                      Background="#CCCCCC" Cursor="SizeNS" ResizeDirection="Rows"/>

        <!-- Results Tabs -->
        <TabControl Grid.Row="4">
            <!-- All Findings -->
            <TabItem Header="ðŸ“‹ All Findings">
                <DataGrid ItemsSource="{Binding Findings}" SelectedItem="{Binding SelectedFinding}"
                          AutoGenerateColumns="False" CanUserAddRows="False" IsReadOnly="True"
                          SelectionMode="Single" GridLinesVisibility="Horizontal">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Type" Binding="{Binding TypeIcon}" Width="50" MinWidth="40" CanUserResize="True"/>
                        <DataGridTextColumn Header="Severity" Binding="{Binding SeverityDisplay}" Width="100" MinWidth="80" CanUserResize="True"/>
                        <DataGridTextColumn Header="Title" Binding="{Binding Title}" Width="250" MinWidth="150" CanUserResize="True"/>
                        <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="*" MinWidth="200" CanUserResize="True"/>
                        <DataGridTextColumn Header="Source" Binding="{Binding Source}" Width="120" MinWidth="80" CanUserResize="True"/>
                        <DataGridTextColumn Header="Time" Binding="{Binding Timestamp, StringFormat={}{0:HH:mm:ss}}" Width="90" MinWidth="70" CanUserResize="True"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

            <!-- Processes -->
            <TabItem Header="ðŸ§  Memory &amp; Processes">
                <DataGrid ItemsSource="{Binding TopProcesses}" AutoGenerateColumns="False" 
                          CanUserAddRows="False" IsReadOnly="True" GridLinesVisibility="Horizontal">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="PID" Binding="{Binding ProcessId}" Width="70" MinWidth="50" CanUserResize="True"/>
                        <DataGridTextColumn Header="Name" Binding="{Binding ProcessName}" Width="180" MinWidth="120" CanUserResize="True"/>
                        <DataGridTextColumn Header="Working Set" Binding="{Binding WorkingSetFormatted}" Width="110" MinWidth="80" CanUserResize="True"/>
                        <DataGridTextColumn Header="Private" Binding="{Binding PrivateBytesFormatted}" Width="100" MinWidth="80" CanUserResize="True"/>
                        <DataGridTextColumn Header="Path" Binding="{Binding ExecutablePath}" Width="*" MinWidth="200" CanUserResize="True"/>
                        <DataGridCheckBoxColumn Header="Suspicious" Binding="{Binding IsSuspicious}" Width="80" MinWidth="60" CanUserResize="True"/>
                        <DataGridTextColumn Header="Reason" Binding="{Binding SuspicionReason}" Width="200" MinWidth="150" CanUserResize="True"/>
                    </DataGrid.Columns>
                    <DataGrid.RowStyle>
                        <Style TargetType="DataGridRow">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsSuspicious}" Value="True">
                                    <Setter Property="Background" Value="#FFEBEE"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.RowStyle>
                </DataGrid>
            </TabItem>

            <!-- Files -->
            <TabItem Header="ðŸ“ Suspicious Files">
                <DataGrid ItemsSource="{Binding SuspiciousFilesList}" AutoGenerateColumns="False" 
                          CanUserAddRows="False" IsReadOnly="True" GridLinesVisibility="Horizontal">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="File Name" Binding="{Binding FileName}" Width="220" MinWidth="150" CanUserResize="True"/>
                        <DataGridTextColumn Header="Size" Binding="{Binding FileSizeFormatted}" Width="90" MinWidth="60" CanUserResize="True"/>
                        <DataGridTextColumn Header="Modified" Binding="{Binding ModifiedTime, StringFormat={}{0:yyyy-MM-dd HH:mm}}" Width="140" MinWidth="100" CanUserResize="True"/>
                        <DataGridCheckBoxColumn Header="Hidden" Binding="{Binding IsHidden}" Width="70" MinWidth="50" CanUserResize="True"/>
                        <DataGridTextColumn Header="Reason" Binding="{Binding Reason}" Width="200" MinWidth="120" CanUserResize="True"/>
                        <DataGridTextColumn Header="Path" Binding="{Binding FilePath}" Width="*" MinWidth="200" CanUserResize="True"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

            <!-- Registry -->
            <TabItem Header="ðŸ“ Registry Entries">
                <DataGrid ItemsSource="{Binding RegistryEntries}" AutoGenerateColumns="False" 
                          CanUserAddRows="False" IsReadOnly="True" GridLinesVisibility="Horizontal">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Name" Binding="{Binding ValueName}" Width="180" MinWidth="100" CanUserResize="True"/>
                        <DataGridTextColumn Header="Value" Binding="{Binding ValueData}" Width="300" MinWidth="150" CanUserResize="True"/>
                        <DataGridTextColumn Header="Key Path" Binding="{Binding KeyPath}" Width="*" MinWidth="200" CanUserResize="True"/>
                        <DataGridCheckBoxColumn Header="Suspicious" Binding="{Binding IsSuspicious}" Width="80" MinWidth="60" CanUserResize="True"/>
                        <DataGridTextColumn Header="Reason" Binding="{Binding Reason}" Width="200" MinWidth="120" CanUserResize="True"/>
                    </DataGrid.Columns>
                    <DataGrid.RowStyle>
                        <Style TargetType="DataGridRow">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsSuspicious}" Value="True">
                                    <Setter Property="Background" Value="#FFEBEE"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.RowStyle>
                </DataGrid>
            </TabItem>

            <!-- Events -->
            <TabItem Header="ðŸ“‹ Security Events">
                <DataGrid ItemsSource="{Binding SecurityEventsList}" AutoGenerateColumns="False" 
                          CanUserAddRows="False" IsReadOnly="True" GridLinesVisibility="Horizontal">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="" Binding="{Binding LevelIcon}" Width="40" MinWidth="30" CanUserResize="True"/>
                        <DataGridTextColumn Header="Time" Binding="{Binding TimeGenerated, StringFormat={}{0:yyyy-MM-dd HH:mm:ss}}" Width="150" MinWidth="120" CanUserResize="True"/>
                        <DataGridTextColumn Header="Event ID" Binding="{Binding EventId}" Width="80" MinWidth="60" CanUserResize="True"/>
                        <DataGridTextColumn Header="Source" Binding="{Binding Source}" Width="180" MinWidth="100" CanUserResize="True"/>
                        <DataGridTextColumn Header="Message" Binding="{Binding Message}" Width="*" MinWidth="200" CanUserResize="True"/>
                        <DataGridTextColumn Header="Reason" Binding="{Binding SuspicionReason}" Width="200" MinWidth="120" CanUserResize="True"/>
                    </DataGrid.Columns>
                    <DataGrid.RowStyle>
                        <Style TargetType="DataGridRow">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsSuspicious}" Value="True">
                                    <Setter Property="Background" Value="#FFF3E0"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.RowStyle>
                </DataGrid>
            </TabItem>
        </TabControl>

        <!-- Status Bar -->
        <Border Grid.Row="5" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0" Padding="5" Margin="0,10,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="Status:" FontWeight="Bold" Margin="0,0,5,0"/>
                    <TextBlock Text="{Binding Status}" TextTrimming="CharacterEllipsis"/>
                </StackPanel>

                <ProgressBar Grid.Column="1" Width="200" Height="18" IsIndeterminate="{Binding IsIndeterminate}"
                             Value="{Binding Progress}" Maximum="100"
                             Visibility="{Binding IsAnalyzing, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
