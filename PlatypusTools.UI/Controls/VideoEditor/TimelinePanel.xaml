<UserControl x:Class="PlatypusTools.UI.Controls.VideoEditor.TimelinePanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:PlatypusTools.UI.Controls.VideoEditor"
             mc:Ignorable="d"
             d:DesignHeight="200" d:DesignWidth="800"
             Background="{DynamicResource WindowBackgroundBrush}">
    
    <UserControl.Resources>
        <!-- Semantic clip colors (keep these as local resources - they are unique to the timeline) -->
        <SolidColorBrush x:Key="VideoClipColor" Color="#5B8A5B"/>
        <SolidColorBrush x:Key="AudioClipColor" Color="#5B5B8A"/>
        <SolidColorBrush x:Key="SelectedClipBorder" Color="#FFCC00"/>
        <SolidColorBrush x:Key="PlayheadColor" Color="#FF4444"/>
        
        <!-- Dark toolbar button style using theme resources -->
        <Style x:Key="ToolbarButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource WindowForegroundBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="28"/>
            <Setter Property="Height" Value="24"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" 
                                CornerRadius="2" Padding="2">
                            <ContentPresenter x:Name="contentPresenter" 
                                              HorizontalAlignment="Center" VerticalAlignment="Center"
                                              TextBlock.Foreground="{TemplateBinding Foreground}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{DynamicResource ControlBackgroundBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="{DynamicResource AccentBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="contentPresenter" Property="TextBlock.Foreground" Value="{DynamicResource DisabledForegroundBrush}"/>
                                <Setter TargetName="border" Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <!-- Timeline toolbar -->
        <Border Grid.Row="0" Background="{DynamicResource SurfaceBrush}" 
                BorderBrush="{DynamicResource ControlBorderBrush}" BorderThickness="0,0,0,1"
                Padding="4">
            <StackPanel Orientation="Horizontal">
                <Button x:Name="MenuButton" Style="{StaticResource ToolbarButton}" ToolTip="Timeline Menu">
                    <TextBlock Text="â˜°" Foreground="{DynamicResource WindowForegroundBrush}"/>
                </Button>
                <Button x:Name="CutButton" Style="{StaticResource ToolbarButton}" ToolTip="Cut (S)" Click="CutButton_Click">
                    <TextBlock Text="âœ‚" Foreground="{DynamicResource WindowForegroundBrush}"/>
                </Button>
                <Button x:Name="CopyButton" Style="{StaticResource ToolbarButton}" ToolTip="Copy (C)">
                    <TextBlock Text="ðŸ“‹" Foreground="{DynamicResource WindowForegroundBrush}"/>
                </Button>
                <Button x:Name="PasteButton" Style="{StaticResource ToolbarButton}" ToolTip="Paste">
                    <TextBlock Text="ðŸ“„" Foreground="{DynamicResource WindowForegroundBrush}"/>
                </Button>
                
                <Separator Width="1" Background="{DynamicResource ControlBorderBrush}" Margin="4,0"/>
                
                <Button x:Name="AppendButton" Style="{StaticResource ToolbarButton}" ToolTip="Append to Track (A)">
                    <TextBlock Text="âž•" Foreground="{DynamicResource WindowForegroundBrush}"/>
                </Button>
                <Button x:Name="RemoveButton" Style="{StaticResource ToolbarButton}" ToolTip="Remove (X)" Click="RemoveButton_Click">
                    <TextBlock Text="ðŸ—‘" Foreground="{DynamicResource WindowForegroundBrush}"/>
                </Button>
                <Button x:Name="LiftButton" Style="{StaticResource ToolbarButton}" ToolTip="Lift (Z)">
                    <TextBlock Text="â¬†" Foreground="{DynamicResource WindowForegroundBrush}"/>
                </Button>
                
                <Separator Width="1" Background="{DynamicResource ControlBorderBrush}" Margin="4,0"/>
                
                <Button x:Name="InsertTrackButton" Style="{StaticResource ToolbarButton}" ToolTip="Insert Track">
                    <TextBlock Text="ðŸŽž" Foreground="{DynamicResource WindowForegroundBrush}"/>
                </Button>
                <ToggleButton x:Name="RippleToggle" Width="28" Height="24"
                              Background="Transparent" BorderThickness="0" ToolTip="Ripple Edit Mode">
                    <TextBlock Text="ðŸ”—" Foreground="{DynamicResource WindowForegroundBrush}"/>
                </ToggleButton>
                
                <Separator Width="1" Background="{DynamicResource ControlBorderBrush}" Margin="4,0"/>
                
                <Button x:Name="ZoomOutButton" Style="{StaticResource ToolbarButton}" ToolTip="Zoom Out" Click="ZoomOutButton_Click">
                    <TextBlock Text="âž–" Foreground="{DynamicResource WindowForegroundBrush}"/>
                </Button>
                
                <Slider x:Name="ZoomSlider" Width="100" Minimum="0.1" Maximum="5" Value="1"
                        VerticalAlignment="Center" Margin="4,0"
                        ValueChanged="ZoomSlider_ValueChanged"/>
                
                <Button x:Name="ZoomInButton" Style="{StaticResource ToolbarButton}" ToolTip="Zoom In" Click="ZoomInButton_Click">
                    <TextBlock Text="âž•" Foreground="{DynamicResource WindowForegroundBrush}"/>
                </Button>
                
                <Button x:Name="ZoomFitButton" Style="{StaticResource ToolbarButton}" ToolTip="Zoom to Fit" Click="ZoomFitButton_Click">
                    <TextBlock Text="â¬œ" Foreground="{DynamicResource WindowForegroundBrush}"/>
                </Button>
            </StackPanel>
        </Border>
        
        <!-- Timeline content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="100"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- Track headers -->
            <ScrollViewer x:Name="TrackHeaderScroll" Grid.Column="0" 
                          VerticalScrollBarVisibility="Hidden"
                          HorizontalScrollBarVisibility="Disabled">
                <Grid>
                    <!-- Spacer to match timeline ruler height -->
                    <Border Height="30" VerticalAlignment="Top" Background="{DynamicResource SurfaceBrush}"/>
                    
                    <ItemsControl x:Name="TrackHeaders" ItemsSource="{Binding Tracks}" Margin="0,30,0,0">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{DynamicResource SurfaceBrush}"
                                        BorderBrush="{DynamicResource ControlBorderBrush}"
                                        BorderThickness="0,0,1,1"
                                        Height="50" Padding="4">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    
                                    <TextBlock Text="{Binding Name}" 
                                               Foreground="{DynamicResource WindowForegroundBrush}"
                                               FontWeight="Bold" FontSize="11"/>
                                    
                                    <StackPanel Grid.Row="1" Orientation="Horizontal" 
                                                VerticalAlignment="Center">
                                        <ToggleButton Width="20" Height="18"
                                                      IsChecked="{Binding IsMuted}"
                                                      Background="Transparent"
                                                      BorderThickness="0"
                                                      ToolTip="Mute Track">
                                            <TextBlock Text="ðŸ”‡" Foreground="{DynamicResource WindowForegroundBrush}" FontSize="10"/>
                                        </ToggleButton>
                                        <ToggleButton Width="20" Height="18"
                                                      IsChecked="{Binding IsHidden}"
                                                      Background="Transparent"
                                                      BorderThickness="0"
                                                      ToolTip="Hide Track">
                                            <TextBlock Text="ðŸ‘" Foreground="{DynamicResource WindowForegroundBrush}" FontSize="10"/>
                                        </ToggleButton>
                                        <ToggleButton Width="20" Height="18"
                                                      IsChecked="{Binding IsLocked}"
                                                      Background="Transparent"
                                                      BorderThickness="0"
                                                      ToolTip="Lock Track">
                                            <TextBlock Text="ðŸ”’" Foreground="{DynamicResource WindowForegroundBrush}" FontSize="10"/>
                                        </ToggleButton>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                </Grid>
            </ScrollViewer>
            
            <!-- Track clips area with scrolling -->
            <ScrollViewer x:Name="TimelineScroll" Grid.Column="1"
                          HorizontalScrollBarVisibility="Auto"
                          VerticalScrollBarVisibility="Auto"
                          ScrollChanged="TimelineScroll_ScrollChanged">
                <Grid x:Name="TimelineGrid" 
                      MouseLeftButtonDown="TimelineGrid_MouseLeftButtonDown"
                      MouseMove="TimelineGrid_MouseMove"
                      MouseLeftButtonUp="TimelineGrid_MouseLeftButtonUp"
                      MouseRightButtonDown="TimelineGrid_MouseRightButtonDown"
                      AllowDrop="True"
                      Drop="TimelineGrid_Drop"
                      DragOver="TimelineGrid_DragOver"
                      Background="{DynamicResource ControlBackgroundBrush}">
                    
                    <!-- Context Menu for Timeline -->
                    <Grid.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Split at Playhead" Click="SplitAtPlayhead_Click" InputGestureText="S">
                                <MenuItem.Icon>
                                    <TextBlock Text="âœ‚" FontSize="14"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator/>
                            <MenuItem Header="Insert Clip..." Click="InsertClip_Click">
                                <MenuItem.Icon>
                                    <TextBlock Text="ðŸ“¥" FontSize="14"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="Append to Track" Click="AppendToTrack_Click" InputGestureText="A">
                                <MenuItem.Icon>
                                    <TextBlock Text="âž•" FontSize="14"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator/>
                            <MenuItem Header="Remove Clip" Click="RemoveClip_Click" InputGestureText="X">
                                <MenuItem.Icon>
                                    <TextBlock Text="ðŸ—‘" FontSize="14"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="Lift (Leave Gap)" Click="LiftClip_Click" InputGestureText="Z">
                                <MenuItem.Icon>
                                    <TextBlock Text="â¬†" FontSize="14"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator/>
                            <MenuItem Header="Add Video Track" Click="AddVideoTrack_Click"/>
                            <MenuItem Header="Add Audio Track" Click="AddAudioTrack_Click"/>
                        </ContextMenu>
                    </Grid.ContextMenu>
                    
                    <!-- Ruler at top -->
                    <local:ScrubBar x:Name="TimelineRuler" 
                                    Height="30" 
                                    VerticalAlignment="Top"
                                    Position="{Binding Position, Mode=TwoWay}"
                                    Duration="{Binding Duration}"/>
                    
                    <!-- Tracks container -->
                    <ItemsControl x:Name="TracksContainer" 
                                  ItemsSource="{Binding Tracks}"
                                  Margin="0,30,0,0">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Canvas x:Name="TrackCanvas" 
                                        Background="{DynamicResource ControlBackgroundBrush}"
                                        Height="50"
                                        Tag="{Binding}">
                                    <!-- Clips will be added programmatically -->
                                </Canvas>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    
                    <!-- Playhead line -->
                    <Canvas x:Name="PlayheadCanvas" IsHitTestVisible="False">
                        <Rectangle x:Name="PlayheadLine" 
                                   Fill="{StaticResource PlayheadColor}"
                                   Width="2"
                                   Height="{Binding ActualHeight, ElementName=TimelineGrid}"/>
                    </Canvas>
                </Grid>
            </ScrollViewer>
        </Grid>
    </Grid>
</UserControl>
