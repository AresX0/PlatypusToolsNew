name: Release Help Check

on:
  release:
    types: [published]

jobs:
  check-release-assets:
    runs-on: ubuntu-latest
    name: Verify release includes help file

    steps:
      - name: Get event payload
        id: evt
        run: |
          cat $GITHUB_EVENT_PATH

      - name: Check assets for PlatypusTools_Help.html or zip containing it
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EVENT_PATH: ${{ github.event_path }}
        shell: pwsh
        run: |
          $evt = Get-Content $env:EVENT_PATH | ConvertFrom-Json
          $assets = $evt.release.assets
          if (-not $assets -or $assets.Count -eq 0) {
            Write-Error "No assets attached to release. Please attach a release asset that contains the help file (PlatypusTools_Help.html)."; exit 1
          }
          $found = $false
          foreach ($a in $assets) {
            if ($a.name -eq 'PlatypusTools_Help.html') { Write-Host "Found direct help asset: $($a.name)"; $found = $true; break }
            if ($a.name -match '\.zip$') {
              $tmp = "$(pwd)/asset_$(Get-Random).zip"
              Write-Host "Downloading asset: $($a.browser_download_url) -> $tmp"
              Invoke-WebRequest -Uri $a.browser_download_url -Headers @{ Authorization = "token $env:GITHUB_TOKEN" } -OutFile $tmp
              Expand-Archive -Path $tmp -DestinationPath "$(pwd)/asset_unzip_$(Get-Random)" -Force
              if (Get-ChildItem -Path $(pwd) -Recurse -Filter 'PlatypusTools_Help.html' -ErrorAction SilentlyContinue) { Write-Host "Found help inside zip: $($a.name)"; $found = $true; break }
            }
          }
          if (-not $found) { Write-Error "Help file not found in release assets. Include 'PlatypusTools_Help.html' or a zip containing it."; exit 1
          } else { Write-Host "Release assets contain help file." }
